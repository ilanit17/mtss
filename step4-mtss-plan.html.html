<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MTSS - בניית תוכנית התערבות וליווי</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      .prose :where(ul):not(:where([class~="not-prose"] *)) { padding-right: 1.625em; }
      .prose :where(ol):not(:where([class~="not-prose"] *)) { padding-right: 1.625em; }
      .form-checkbox { appearance: none; padding: 0; display: inline-block; vertical-align: middle; background-origin: border-box; user-select: none; flex-shrink: 0; height: 1rem; width: 1rem; color: #0d9488; background-color: #fff; border-color: #9ca3af; border-width: 1px; border-radius: 0.25rem; }
      .form-checkbox:checked { background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e"); border-color: transparent; background-color: currentColor; background-size: 100% 100%; background-position: center; background-repeat: no-repeat; }
      .form-checkbox:focus { outline: 2px solid transparent; outline-offset: 2px; --tw-ring-inset: var(--tw-empty,/*!*/ /*!*/); --tw-ring-offset-width: 2px; --tw-ring-offset-color: #fff; --tw-ring-color: #0d9488; --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color); box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); }
      .fade-in { animation: fadeIn 0.5s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .suggestion-bank { max-height: 400px; overflow-y: auto; }
      .item-card { transition: all 0.2s ease-in-out; }
      .item-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gradient-to-br from-teal-600 via-green-500 to-yellow-400 min-h-screen">
    <div class="container mx-auto p-4 md:p-8 selection:bg-yellow-300 selection:text-yellow-900">
      <header id="app-header" class="text-center mb-8 bg-white/90 backdrop-blur-md text-teal-700 p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-4xl md:text-5xl font-bold mb-3 bg-clip-text text-transparent bg-gradient-to-r from-teal-500 via-green-600 to-yellow-500">
          🎯 בניית תוכנית התערבות וליווי MTSS
        </h1>
        <p id="step-description-el" class="text-lg md:text-xl text-gray-600"></p>
      </header>

      <div id="loading-indicator-el" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="text-white text-xl p-6 bg-teal-600 rounded-lg shadow-xl animate-pulse">טוען נתונים...</div>
      </div>
      <div id="error-message-el" class="mb-4 p-4 bg-red-500 text-white rounded-lg shadow-md text-center" style="display: none;"></div>
      <div id="success-message-el" class="mb-4 p-4 bg-green-500 text-white rounded-lg shadow-md text-center" style="display: none;"></div>

      <main id="app-content-el" class="bg-white/90 backdrop-blur-md p-6 md:p-8 rounded-xl shadow-xl">
        <!-- Step content will be rendered here -->
      </main>
      <div id="action-buttons-container-el" class="flex justify-center gap-4 mt-8">
        <!-- Action buttons will be rendered here -->
      </div>
    </div>

    <script>
      // --- CONSTANTS ---
      const DEMO_EXTRACTED_DATA = { issueFile: true, dataFile: true, challenge: 'אתגרי שפה וקריאה', main_issue_question: 'כיצד ניתן לפתח ולהעצים את התפיסות והאמונות המקצועיות של הצוותים החינוכיים, באמצעות למידת עמיתים, הכשרות ממוקדות וליווי אישי, על מנת להוביל לשינוי בפרקטיקות ההוראה ולשפר את הישגי התלמידים?', vision: 'צוות חינוכי בעל תחושת מסוגלות גבוהה, המאמין ביכולתו לקדם כל תלמיד ומצויד בכלים המתאימים לכך.', schools: [ { name: 'בי"ס אלונים', tier: 2, challenges: [{ category: 'שפה', text: 'רמת הבנת הנקרא אינה מספקת' }, { category: 'מתמטיקה', text: 'חרדת מתמטיקה' }] }, { name: 'בי"ס הדקלים', tier: 3, challenges: [{ category: 'שפה', text: 'רמת הבנת הנקרא אינה מספקת' }, { category: 'שפה', text: 'אוצר מילים מוגבל' }] }, { name: 'בי"ס כרמלים', tier: 2, challenges: [{ category: 'שפה', text: 'רמת הבנת הנקרא אינה מספקת' }, { category: 'יציבות צוות', text: 'תחלופה גבוהה של צוות' }] }, { name: 'בי"ס הגליל', tier: 1, challenges: [] }, { name: 'בי"ס הזיתים', tier: 1, challenges: [] }, ] };
      const INITIAL_INTERVENTION_PLAN = { mainGoal: '', smartObjectives: [], tier1: { outcomes: [] }, tier2Groups: [], tier3: { outcomes: [] }, };
      const ALL_SUGGESTIONS = { mainGoalSuggestions: ['שיפור איכות ההוראה והלמידה בתחום הסוגייה', 'הטמעת תרבות ארגונית של שימוש בנתונים', 'חיזוק תחושת המסוגלות של הצוותים'], smartObjectivesSuggestions: ['עד סוף שנה, 80% מהמורים ידווחו על שימוש בפרקטיקה חדשה.', 'עליה של 15% בממוצע הציונים הבית-ספרי בתחום הנדון.', '100% מהמנהלים יציגו תוכנית התערבות בית-ספרית מבוססת נתונים.'], tier1Suggestions: ['כלל המנהלים יגבשו תפיסה בית-ספרית אחידה בנושא.', '100% מצוותי ההוראה יעברו השתלמות בסיסית.', 'הטמעת שפה מקצועית משותפת בכל בתי הספר.'], tier3Suggestions: ['בניית תוכנית עבודה מותאמת אישית לבתי הספר המאתגרים ביותר.', 'צוותי הניהול בבתי הספר המלווים יובילו ישיבות נתונים.', 'השגת שיפור מדיד ומשמעותי בתוצאות התלמידים.'] };
      
      const INITIAL_SUPPORT_PLAN = { coreActions: [], partners: [], resources: [], operationalPlan: [], };
      const ACTION_CATEGORIES = ['הדרכה והכשרה', 'פיתוח מקצועי', 'תמיכה וליווי', 'בניית מערכות'];
      const PARTNER_CATEGORIES = ['גורמים פנים בית ספריים', 'גורמים מחוזיים', 'מוסדות אקדמיים', 'גורמים חיצוניים וקהילה'];
      const RESOURCE_CATEGORIES = ['משאבי זמן', 'משאבים כספיים', 'מומחיות ואנשים', 'חומרים וכלים', 'טכנולוגיה ותשתית'];
      const TASK_STATUSES = ['טרם החל', 'בתהליך', 'הושלם', 'בסיכון'];
      // *** NEW DROPDOWN OPTIONS ***
      const TIER_OPTIONS = ['כל הרמות', 'רמה 1', 'רמה 2', 'רמה 3'];
      const TARGET_AUDIENCE_OPTIONS = ['כלל המנהלים', 'מנהלים חדשים', 'צוותי ניהול', 'מנהלים ב-Tier 2', 'מנהלים ב-Tier 3', 'סגני מנהלים', 'מורים מובילים'];
      const FREQUENCY_OPTIONS = ['יומית', 'שבועית', 'דו-שבועית', 'חודשית', 'רבעונית', 'חצי שנתית', 'לפי צורך'];
      
      const SUGGESTED_ACTIONS_BANK = [ { name: 'ליווי אישי רציף למנהל', category: 'תמיכה וליווי', tier: 'כל הרמות', description: 'פגישות עבודה אישיות ממוקדות (60-90 דקות) לליווי צמוד, תמיכה בקבלת החלטות וזמינות לייעוץ דחוף.' }, { name: 'הכשרות ממוקדות', category: 'הדרכה והכשרה', tier: 'כל הרמות', description: 'ארגון הכשרות מותאמות אישית לצרכים ספציפיים שעלו, כגון ניהול כספים, מנהיגות פדגוגית, ניהול שינוי.' }, { name: 'פיתוח מנהיגות עמיתים', category: 'פיתוח מקצועי', tier: 'רמה 1', description: 'הכשרת מנהלים מצטיינים להובלת קבוצות עמיתים, חניכה והובלת פרויקטים מערכתיים.' }, { name: 'מנטורינג ממנהלים מנוסים', category: 'תמיכה וליווי', tier: 'רמה 2', description: 'חיבור מנהלים למנהלים ותיקים ומנוסים לליווי, העברת ידע וביקורים הדדיים בבתי הספר.' }, { name: 'ביקורי כיתה משותפים', category: 'בניית מערכות', tier: 'רמה 3', description: 'תצפיות משותפות של המפקח והמנהל בכיתות, למטרת ליווי פדגוגי ישיר, כיול וליווי שיח המנהל עם המורים.' }, { name: 'צוות תמיכה רב-מקצועי', category: 'תמיכה וליווי', tier: 'רמה 3', description: 'הקמת צוות תמיכה ייעודי הכולל גורמים מהמטה, יועצים ומומחים חיצוניים למתן מענה אינטנסיבי.' }, { name: 'קהילת למידה מקצועית (PLC)', category: 'פיתוח מקצועי', tier: 'רמה 1', description: 'הקמת פורום קבוע של מנהלים לדיון בסוגיות משותפות, שיתוף פרקטיקות מיטביות ולמידה הדדית.' }, { name: 'סדנת ניתוח נתונים', category: 'בניית מערכות', tier: 'רמה 2', description: 'סדנה מעשית לניתוח מעמיק של נתוני בית הספר, זיהוי מגמות וקבלת החלטות מבוססת נתונים.' }, ];
      const SUGGESTED_PARTNERS_BANK = [ { name: 'מנהלים ותיקים/מצטיינים', category: 'גורמים פנים בית ספריים', role: 'מנטורים, מובילי עמיתים' }, { name: 'מדריך/ה מחוזי/ת', category: 'גורמים מחוזיים', role: 'מומחה תוכן, מלווה פדגוגי' }, { name: 'יועץ/ת ארגוני/ת', category: 'גורמים חיצוניים וקהילה', role: 'ליווי תהליכי שינוי, פיתוח צוות' }, { name: 'חוקר/ת מהאקדמיה', category: 'מוסדות אקדמיים', role: 'ליווי מבוסס מחקר, הערכה מעצבת' }, { name: 'מנהל מחלקת חינוך ברשות', category: 'גורמים חיצוניים וקהילה', role: 'גיוס משאבים, תמיכה רשותית' }, { name: 'רכז/ת תקשוב בית ספרי', category: 'גורמים פנים בית ספריים', role: 'תמיכה טכנולוגית, הדרכת כלים דיגיטליים' }, ];
      const SUGGESTED_RESOURCES_BANK = [ { name: 'שעות ליווי מפקח', category: 'משאבי זמן', details: 'הקצאת שעות שבועיות/חודשיות בהתאם לרמת ה-MTSS' }, { name: 'תקציב גפ"ן', category: 'משאבים כספיים', details: 'מיקוד סעיפים בתקציב הגמיש לצורך תמיכה במנהיגות ופיתוח צוות' }, { name: 'מאגר מומחים מחוזי', category: 'מומחיות ואנשים', details: 'שימוש במאגר היועצים והמדריכים של המחוז' }, { name: 'ערכות הדרכה למנהלים', category: 'חומרים וכלים', details: 'שימוש והתאמה של ערכות קיימות ממשרד החינוך' }, { name: 'פלטפורמת למידה מקוונת', category: 'טכנולוגיה ותשתית', details: 'שימוש בפלטפורמה קיימת ליצירת מרחב למידה למנהלים' }, ];

      const STEP_DESCRIPTIONS = [ "שלב 0: העלאת קבצים והכנת נתונים", "שלב 1: הגדרת מטרות ויעדים", "שלב 2: תכנון התערבות MTSS", "שלב 3: סיכום תוכנית ההתערבות", "שלב 4: בחירת פעולות ליבה לליווי", "שלב 5: זיהוי שותפים ומשאבים", "שלב 6: בניית תוכנית עבודה אופרטיבית", "שלב 7: סיכום והפקת דוח ליווי" ];

      // --- STATE VARIABLES ---
      let currentStep = 0; let extractedData = null; let interventionPlan = JSON.parse(JSON.stringify(INITIAL_INTERVENTION_PLAN)); let supportPlan = JSON.parse(JSON.stringify(INITIAL_SUPPORT_PLAN)); let loading = false; let error = null; let success = null; let tempExtractedDataForStep0 = { issueFile: false, dataFile: false, schools: [] }; let issueFileUploadedStep0 = false; let dataFileUploadedStep0 = false; let suggestedTier2GroupsStep2 = [];

      // --- DOM ELEMENTS CACHE ---
      const stepDescriptionEl = document.getElementById('step-description-el'); const loadingIndicatorEl = document.getElementById('loading-indicator-el'); const errorMessageEl = document.getElementById('error-message-el'); const successMessageEl = document.getElementById('success-message-el'); const appContentEl = document.getElementById('app-content-el'); const actionButtonsContainerEl = document.getElementById('action-buttons-container-el');

      // --- UTILITY FUNCTIONS ---
      function displayMessage(type, message) { if (type === 'error') { error = message; errorMessageEl.textContent = message; errorMessageEl.style.display = 'block'; } if (type === 'success') { success = message; successMessageEl.textContent = message; successMessageEl.style.display = 'block'; } setTimeout(() => { resetMessages(); renderApp(); }, 5000); }
      function setLoadingState(isLoading) { loading = isLoading; loadingIndicatorEl.style.display = loading ? 'flex' : 'none'; }
      function moveToStep(step) { currentStep = step; window.scrollTo({ top: 0, behavior: 'smooth' }); renderApp(); }
      function resetMessages() { error = null; success = null; errorMessageEl.style.display = 'none'; errorMessageEl.textContent = ''; successMessageEl.style.display = 'none'; successMessageEl.textContent = ''; }
      function goBack() { if (currentStep > 0) { moveToStep(currentStep - 1); resetMessages(); } }
      function startNew() { extractedData = null; interventionPlan = JSON.parse(JSON.stringify(INITIAL_INTERVENTION_PLAN)); supportPlan = JSON.parse(JSON.stringify(INITIAL_SUPPORT_PLAN)); tempExtractedDataForStep0 = { issueFile: false, dataFile: false, schools: [] }; issueFileUploadedStep0 = false; dataFileUploadedStep0 = false; suggestedTier2GroupsStep2 = []; resetMessages(); moveToStep(0); }
      function escapeHtml(unsafe) { if (unsafe === null || unsafe === undefined) return ''; return String(unsafe).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

      // --- COMPONENT-LIKE RENDER FUNCTIONS ---
      function renderFileUploadButton(id, label, description, icon, uploaded, accept, fileType) { const uniqueInputId = `file-input-${id}-${fileType}`; return `<div onclick="document.getElementById('${uniqueInputId}').click()" class="p-6 border-3 rounded-xl text-center cursor-pointer transition-all duration-300 ease-in-out transform hover:scale-105 ${uploaded ? 'border-green-500 bg-green-50 shadow-lg' : 'border-dashed border-teal-500 bg-teal-50 hover:border-teal-600 hover:bg-teal-100'}"><input type="file" id="${uniqueInputId}" onchange="handleFileUploadEvent(event, ${fileType})" class="hidden" accept="${accept}"/><div class="text-5xl mb-3 ${uploaded ? 'text-green-600' : 'text-teal-600'}">${icon}</div><h3 class="text-xl font-semibold mb-1 ${uploaded ? 'text-green-700' : 'text-teal-700'}">${escapeHtml(label)}</h3><p class="text-sm ${uploaded ? 'text-green-600' : 'text-gray-600'}">${escapeHtml(description)}</p>${uploaded ? `<span class="mt-2 inline-block text-xs font-semibold text-green-700 bg-green-200 px-2 py-0.5 rounded-full">הקובץ הועלה</span>` : ''}</div>`; }
      function renderSuggestionTextarea(id, label, value, rows, placeholder, suggestions, suggestionIdSuffix, onChangeCallbackString) { const uniqueTextareaId = `textarea-${id}-${suggestionIdSuffix}`; const uniqueSelectId = `select-${id}-${suggestionIdSuffix}`; const suggestionsHtml = suggestions.map((sugg, index) => `<option key="${index}" value="${escapeHtml(sugg)}">${sugg.length > 70 ? escapeHtml(sugg.substring(0, 67)) + "..." : escapeHtml(sugg)}</option>`).join(''); return `<div class="form-group space-y-2"><label htmlFor="${uniqueTextareaId}" class="block mb-2 text-lg font-semibold text-gray-700">${escapeHtml(label)}</label><textarea id="${uniqueTextareaId}" rows="${rows}" placeholder="${escapeHtml(placeholder)}" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-colors" oninput="${onChangeCallbackString}(this.value)">${escapeHtml(value)}</textarea><div class="flex shadow-sm rounded-lg"><button type="button" onclick="handleAddSuggestionToTextarea('${uniqueTextareaId}', '${uniqueSelectId}')" class="px-4 py-3 bg-teal-500 text-white font-semibold rounded-l-lg hover:bg-teal-600 transition-colors focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50">הוסף הצעה</button><select id="${uniqueSelectId}" class="flex-grow p-3 border border-gray-300 rounded-r-lg bg-gray-50 focus:ring-teal-500 focus:border-teal-500 outline-none" defaultValue=""><option value="" disabled selected>בחר הצעה מהרשימה...</option>${suggestionsHtml}</select></div></div>`; }
      
      // *** BUG FIX in handleAddSuggestionToTextarea ***
      function handleAddSuggestionToTextarea(textareaId, selectId) {
          const selectElement = document.getElementById(selectId);
          const textareaElement = document.getElementById(textareaId);
          const selectedValue = selectElement.value;
          if (!selectedValue || !textareaElement) return;
          const currentText = textareaElement.value;
          const newText = (currentText.trim() ? currentText + '\\n' : '') + `• ${selectedValue}`;
          textareaElement.value = newText;
          // This is the fix: Programmatically trigger the 'oninput' event
          const event = new Event('input', { bubbles: true, cancelable: true });
          textareaElement.dispatchEvent(event);
          selectElement.selectedIndex = 0;
      }
      
      function renderSchoolTag(name, color = 'blue') { const colorClasses = { green: 'bg-green-100 text-green-700 border-green-300', yellow: 'bg-yellow-100 text-yellow-700 border-yellow-300', red: 'bg-red-100 text-red-700 border-red-300', blue: 'bg-blue-100 text-blue-700 border-blue-300', gray: 'bg-gray-100 text-gray-700 border-gray-300', }; return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${colorClasses[color]}">${escapeHtml(name)}</span>`; }

      // --- STEP 0: UPLOAD ---
      function parseIssueFile(doc) { const dataDiv = doc.getElementById('data-for-next-app'); if (!dataDiv) throw new Error("קובץ סוגייה לא תקין (חסר #data-for-next-app)."); const challenge = dataDiv.querySelector('[data-key="challenge"]')?.textContent?.trim() || 'לא צוין'; const main_issue_question = dataDiv.querySelector('[data-key="main_issue_question"]')?.textContent?.trim() || 'לא צוין'; const vision = dataDiv.querySelector('[data-key="vision"]')?.textContent?.trim() || 'לא צוין'; if (main_issue_question === 'לא צוין') throw new Error("שאלת הסוגיה חסרה בקובץ."); return { challenge, main_issue_question, vision, issueFile: true }; }
      function parseDataFile(doc) { const schoolElements = doc.querySelectorAll('.school-item'); if (schoolElements.length === 0) throw new Error("קובץ נתונים לא תקין (חסר .school-item)."); const schools = Array.from(schoolElements).map(el => { const name = el.querySelector('strong')?.textContent?.trim() || 'לא ידוע'; const challenges = Array.from(el.querySelectorAll('.school-challenges li')).map(li => { const parts = li.textContent?.split(':') || []; return { category: parts[0]?.trim() || 'כללי', text: parts[1]?.trim() || li.textContent?.trim() || '' }; }); const tierEl = el.closest('.mtss-tier'); let tier = 1; if (tierEl?.classList.contains('tier-2')) tier = 2; else if (tierEl?.classList.contains('tier-3')) tier = 3; return { name, challenges, tier }; }); return { schools, dataFile: true }; }
      function checkAllFilesUploadedStep0() { if (tempExtractedDataForStep0.issueFile && tempExtractedDataForStep0.dataFile) { extractedData = { ...tempExtractedDataForStep0 }; displayMessage('success', 'כל הקבצים הועלו ונותחו בהצלחה!'); renderApp(); } }
      async function handleFileUploadEvent(event, fileType) { const file = event.target.files[0]; if (!file) return; if (!file.name.toLowerCase().endsWith('.html') && !file.name.toLowerCase().endsWith('.htm')) { displayMessage('error', "סוג קובץ לא נתמך. יש להעלות קובץ HTML."); return; } setLoadingState(true); try { const fileContent = await file.text(); const doc = new DOMParser().parseFromString(fileContent, 'text/html'); let parsedUpdate = {}; if (fileType === 1) { parsedUpdate = parseIssueFile(doc); issueFileUploadedStep0 = true; } else if (fileType === 2) { parsedUpdate = parseDataFile(doc); dataFileUploadedStep0 = true; } tempExtractedDataForStep0 = { ...tempExtractedDataForStep0, ...parsedUpdate }; checkAllFilesUploadedStep0(); } catch (err) { displayMessage('error', `שגיאה בעיבוד קובץ: ${err.message}`); if (fileType === 1) issueFileUploadedStep0 = false; if (fileType === 2) dataFileUploadedStep0 = false; } finally { setLoadingState(false); renderApp(); } }
      function loadDemoData() { setLoadingState(true); setTimeout(() => { tempExtractedDataForStep0 = JSON.parse(JSON.stringify(DEMO_EXTRACTED_DATA)); issueFileUploadedStep0 = true; dataFileUploadedStep0 = true; extractedData = { ...tempExtractedDataForStep0 }; displayMessage('success', 'נתוני הדגמה נטענו בהצלחה!'); setLoadingState(false); renderApp(); }, 500); }
      function renderStep0Upload() { const allFilesProcessed = issueFileUploadedStep0 && dataFileUploadedStep0 && extractedData; let summaryHtml = ''; if (allFilesProcessed && extractedData.main_issue_question && extractedData.schools) { summaryHtml = `<div class="mt-6 p-6 bg-green-50 border-r-4 border-green-500 rounded-lg shadow"><h3 class="text-xl font-semibold text-green-700 mb-3">✅ סיכום נתונים:</h3><p class="text-gray-700"><strong>שאלת הסוגייה:</strong> ${escapeHtml(extractedData.main_issue_question)}</p><p class="text-gray-700"><strong>בתי ספר:</strong> ${extractedData.schools.length}</p></div>`; } appContentEl.innerHTML = `<div class="space-y-6"><div class="grid md:grid-cols-2 gap-6">${renderFileUploadButton('issueFile', '1. העלה קובץ סוגייה', 'קובץ HTML שנוצר בכלי ניתוח סוגייה.', '📜', issueFileUploadedStep0, '.html,.htm', 1)}${renderFileUploadButton('dataFile', '2. העלה קובץ נתונים', 'קובץ HTML שנוצר בכלי ניתוח נתונים.', '📊', dataFileUploadedStep0, '.html,.htm', 2)}</div><div class="text-center"><button onclick="loadDemoData()" class="px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600">טען נתוני הדגמה</button></div>${summaryHtml}<div class="text-center mt-8"><button onclick="if(!this.disabled) moveToStep(1)" ${!allFilesProcessed ? 'disabled' : ''} class="px-8 py-4 bg-gradient-to-r from-teal-500 to-green-600 text-white text-lg font-semibold rounded-lg shadow-xl hover:from-teal-600 hover:to-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed">המשך לשלב 1 →</button></div></div>`; }
      
      // --- STEP 1: GOALS ---
      function handleMainGoalChange(value) { interventionPlan.mainGoal = value; renderActionButtons(); }
      function handleSmartObjectivesChange(value) { interventionPlan.smartObjectives = value.split('\\n'); renderActionButtons(); }
      function renderStep1Goals() { appContentEl.innerHTML = `<div class="space-y-8"><div>${renderSuggestionTextarea('mainGoal', 'מטרה מרכזית (מה נרצה להשיג?)', interventionPlan.mainGoal, 3, 'תאר את המטרה המרכזית של תוכנית ההתערבות.', ALL_SUGGESTIONS.mainGoalSuggestions, 'mainGoalSugg', 'handleMainGoalChange')}</div><div>${renderSuggestionTextarea('smartObjectives', 'יעדים תפעוליים (SMART)', interventionPlan.smartObjectives.join('\\n'), 4, 'הגדר 2-3 יעדים ספציפיים, מדידים, ברי השגה, רלוונטיים ומוגדרים בזמן.', ALL_SUGGESTIONS.smartObjectivesSuggestions, 'smartObjSugg', 'handleSmartObjectivesChange')}</div></div>`; }

      // --- STEP 2: MTSS ---
      function handleTier1OutcomesChange(value) { interventionPlan.tier1.outcomes = value.split('\\n'); renderActionButtons(); }
      function handleTier3OutcomesChange(value) { interventionPlan.tier3.outcomes = value.split('\\n'); renderActionButtons(); }
      function generateSuggestedTier2Groups() { if (!extractedData || !extractedData.schools) { suggestedTier2GroupsStep2 = []; return; } const challengeCounts = {}; extractedData.schools.forEach(school => { school.challenges.forEach(challenge => { if (!challengeCounts[challenge.text]) { challengeCounts[challenge.text] = []; } challengeCounts[challenge.text].push(school.name); }); }); const sortedChallenges = Object.entries(challengeCounts).map(([text, schools]) => ({ text, schools, count: schools.length })).sort((a, b) => b.count - a.count); suggestedTier2GroupsStep2 = sortedChallenges.slice(0, 3).filter(c => c.schools.length >= 2).map(c => ({ name: `קבוצה לטיפול ב: ${c.text}`, schools: c.schools, challengeText: c.text, id: `sugg-${Date.now()}-${Math.random()}` })); }
      function addSuggestedTier2GroupToPlan(suggestionId) { const suggestion = suggestedTier2GroupsStep2.find(s => s.id === suggestionId); if (suggestion) { addTier2GroupToPlan(suggestion.name, [`התמודדות ממוקדת עם "${suggestion.challengeText}"`], suggestion.schools); suggestedTier2GroupsStep2 = suggestedTier2GroupsStep2.filter(s => s.id !== suggestionId); renderStep2MTSS(); } }
      function addTier2GroupToPlan(name = '', outcomes = [], schools = []) { interventionPlan.tier2Groups.push({ id: String(Date.now()) + Math.random(), name: name || `קבוצת התערבות ${interventionPlan.tier2Groups.length + 1}`, outcomes, schools }); renderStep2MTSS(); }
      function removeTier2GroupFromPlan(id) { interventionPlan.tier2Groups = interventionPlan.tier2Groups.filter(g => g.id !== id); renderStep2MTSS(); }
      function handleTier2GroupNameChange(groupId, value) { const group = interventionPlan.tier2Groups.find(g => g.id === groupId); if (group) group.name = value; }
      function handleTier2GroupOutcomesChange(groupId, value) { const group = interventionPlan.tier2Groups.find(g => g.id === groupId); if (group) group.outcomes = value.split('\\n').filter(o => o.trim()); }
      function handleTier2GroupSchoolToggle(groupId, schoolName) { const group = interventionPlan.tier2Groups.find(g => g.id === groupId); if (group) { const schoolIndex = group.schools.indexOf(schoolName); if (schoolIndex > -1) { group.schools.splice(schoolIndex, 1); } else { group.schools.push(schoolName); } renderStep2MTSS(); } }
      function renderTier2GroupItem(group, allSchoolNames) { const schoolCheckboxesHtml = allSchoolNames.map(schoolName => `<label class="flex items-center space-x-2 rtl:space-x-reverse cursor-pointer p-1 hover:bg-yellow-100 rounded"><input type="checkbox" class="form-checkbox h-4 w-4 text-yellow-500 border-gray-300 rounded focus:ring-yellow-400" ${group.schools.includes(schoolName) ? 'checked' : ''} onchange="handleTier2GroupSchoolToggle('${group.id}', '${escapeHtml(schoolName)}')"/><span class="text-sm text-gray-700">${escapeHtml(schoolName)}</span></label>`).join(''); return `<div class="p-5 border border-yellow-400 bg-white rounded-lg shadow-sm space-y-4"><div class="form-group"><label for="${group.id}-name" class="block text-sm font-medium text-gray-700 mb-1">שם הקבוצה</label><input type="text" id="${group.id}-name" value="${escapeHtml(group.name)}" oninput="handleTier2GroupNameChange('${group.id}', event.target.value)" placeholder="לדוגמה: קבוצת תמיכה בשפה" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500"/></div><div class="form-group"><label for="${group.id}-outcomes" class="block text-sm font-medium text-gray-700 mb-1">תוצרים/פעולות</label><textarea id="${group.id}-outcomes" rows="3" oninput="handleTier2GroupOutcomesChange('${group.id}', event.target.value)" placeholder="הגדר תוצרים או פעולות ספציפיות לקבוצה זו." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500">${escapeHtml(group.outcomes.join('\\n'))}</textarea></div><div class="form-group"><label class="block text-sm font-medium text-gray-700 mb-1">שיוך בתי ספר:</label>${allSchoolNames.length > 0 ? `<div class="max-h-32 overflow-y-auto p-2 border border-gray-300 rounded-md bg-gray-50 space-y-1">${schoolCheckboxesHtml}</div>` : '<p class="text-sm text-gray-500 italic">לא נמצאו בתי ספר.</p>'}</div><button onclick="removeTier2GroupFromPlan('${group.id}')" class="px-4 py-2 bg-red-500 text-white text-sm font-semibold rounded-md hover:bg-red-600 shadow">- הסר קבוצה</button></div>`; }
      function renderStep2MTSS() {
        if (!extractedData) { appContentEl.innerHTML = `<p class="text-center text-red-500">שגיאה: יש להעלות קבצים בשלב 0.</p>`; return; }
        generateSuggestedTier2Groups();
        const tier3Schools = extractedData?.schools.filter(s => s.tier === 3).map(s => s.name) || []; const allSchoolNames = extractedData?.schools.map(s => s.name) || []; let suggestedGroupsHtml = ''; if (suggestedTier2GroupsStep2.length > 0) { suggestedGroupsHtml = `<div class="mb-6"><h4 class="text-xl font-medium text-yellow-600 mb-3">הצעות לקבוצות התערבות:</h4><div class="space-y-4">${suggestedTier2GroupsStep2.map(sugg => `<div key="${sugg.id}" class="p-4 bg-yellow-100 border border-yellow-300 rounded-lg"><p class="font-semibold">${escapeHtml(sugg.name)}</p><div class="my-2 flex flex-wrap gap-2"><span class="font-medium text-sm text-yellow-700">בתי ספר (${sugg.schools.length}):</span>${sugg.schools.map(sName => renderSchoolTag(sName, "yellow")).join('')}</div><button onclick="addSuggestedTier2GroupToPlan('${sugg.id}')" class="mt-2 px-4 py-1.5 bg-yellow-500 text-white text-sm font-semibold rounded-md hover:bg-yellow-600">+ הוסף קבוצה</button></div>`).join('')}</div><hr class="my-6 border-yellow-300" /></div>`; }
        const tier2GroupsHtml = interventionPlan.tier2Groups.map(group => renderTier2GroupItem(group, allSchoolNames)).join('');
        appContentEl.innerHTML = `<div class="space-y-10"><div class="p-6 border-2 border-green-500 bg-green-50 rounded-xl shadow-md"><h3 class="flex items-center gap-3 text-2xl font-semibold text-green-700 mb-4"><span class="text-3xl">🌍</span> Tier 1: אוניברסלי</h3>${renderSuggestionTextarea('tier1Outcomes', 'תוצרים/פעולות', interventionPlan.tier1.outcomes.join('\\n'), 3, 'הגדר תוצרים או פעולות לכל בתי הספר.', ALL_SUGGESTIONS.tier1Suggestions, 't1sugg', 'handleTier1OutcomesChange')}</div><div class="p-6 border-2 border-yellow-500 bg-yellow-50 rounded-xl shadow-md"><h3 class="flex items-center gap-3 text-2xl font-semibold text-yellow-700 mb-4"><span class="text-3xl">🎯</span> Tier 2: קבוצתי</h3>${suggestedGroupsHtml}<h4 class="text-xl font-medium text-yellow-600 mb-3">קבוצות מוגדרות:</h4><div class="space-y-6 mb-6">${tier2GroupsHtml || '<p class="text-gray-500 italic">לא הוגדרו קבוצות.</p>'}</div><button onclick="addTier2GroupToPlan()" class="px-5 py-2.5 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600">+ הוסף קבוצה</button></div><div class="p-6 border-2 border-red-500 bg-red-50 rounded-xl shadow-md"><h3 class="flex items-center gap-3 text-2xl font-semibold text-red-700 mb-4"><span class="text-3xl">🔍</span> Tier 3: אינטנסיבי</h3>${tier3Schools.length > 0 ? `<div class="mb-4 p-4 bg-red-100 border-r-4 border-red-400 rounded-md"><strong class="text-red-600">בתי ספר ב-Tier 3:</strong><div class="mt-2 flex flex-wrap gap-2">${tier3Schools.map(name => renderSchoolTag(name, 'red')).join('')}</div></div>` : ''}${renderSuggestionTextarea('tier3Outcomes', 'תוצרים/פעולות', interventionPlan.tier3.outcomes.join('\\n'), 3, 'הגדר תוצרים עבור בתי הספר הזקוקים לתמיכה אינטנסיבית.', ALL_SUGGESTIONS.tier3Suggestions, 't3sugg', 'handleTier3OutcomesChange')}</div></div>`;
        renderActionButtons();
      }

      // --- STEP 3: INTERVENTION SUMMARY ---
      function renderStep3Report() { if (!extractedData) { appContentEl.innerHTML = `<p class="text-center text-red-500">שגיאה: יש להעלות קבצים.</p>`; return; } appContentEl.innerHTML = `<div class="space-y-6"><div class="p-6 bg-white border border-gray-200 rounded-xl shadow-lg prose prose-lg max-w-none prose-headings:text-teal-600 prose-h3:text-gray-700"><h2 class="text-3xl font-semibold text-center text-teal-700 mb-6 pb-2 border-b-2 border-teal-300">סיכום תוכנית ההתערבות</h2><p class="text-center text-gray-600">זהו סיכום תוכנית ההתערבות. בשלב הבא, נבנה על בסיס זה את תוכנית הליווי האופרטיבית.</p><div class="p-4 mt-6 mb-4 bg-gray-50 rounded-lg border-l-4 border-teal-500"><h3 class="text-xl font-semibold">שאלת הסוגייה:</h3><p class="text-gray-700">${escapeHtml(extractedData?.main_issue_question) || 'לא הוגדרה.'}</p></div><div class="p-4 mb-4 bg-gray-50 rounded-lg border-l-4 border-teal-500"><h3 class="text-xl font-semibold">מטרה מרכזית:</h3><p class="text-gray-700">${escapeHtml(interventionPlan.mainGoal) || 'לא הוגדרה.'}</p></div></div></div>`; }
      
      // --- Step 4: Core Actions ---
      function handleAddAction(suggestion = {}) { const newAction = { id: `action_${Date.now()}`, name: suggestion.name || 'פעולה חדשה', description: suggestion.description || '', category: suggestion.category || ACTION_CATEGORIES[0], tier: suggestion.tier || TIER_OPTIONS[0], targetAudience: TARGET_AUDIENCE_OPTIONS[0], frequency: FREQUENCY_OPTIONS[0], }; supportPlan.coreActions.push(newAction); renderStep4Actions(); }
      function handleUpdateAction(id, field, value) { const action = supportPlan.coreActions.find(a => a.id === id); if(action) action[field] = value; }
      function handleRemoveAction(id) { supportPlan.coreActions = supportPlan.coreActions.filter(a => a.id !== id); renderStep4Actions(); }
      function renderStep4Actions() {
        const selectedActionsHtml = supportPlan.coreActions.map(action => `
          <div class="item-card p-4 border rounded-lg bg-white shadow-sm space-y-3 fade-in">
            <div class="flex justify-between items-center">
                <input type="text" class="text-lg font-semibold border-b-2 border-transparent focus:border-teal-500 outline-none w-full" value="${escapeHtml(action.name)}" oninput="handleUpdateAction('${action.id}', 'name', this.value)">
                <button onclick="handleRemoveAction('${action.id}')" class="text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>
            </div>
            <div><label class="text-sm font-medium text-gray-600">תיאור הפעולה</label><textarea class="w-full p-2 border border-gray-300 rounded-md mt-1" rows="3" oninput="handleUpdateAction('${action.id}', 'description', this.value)">${escapeHtml(action.description)}</textarea></div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div><label class="text-sm font-medium text-gray-600">קטגוריה</label><select class="w-full p-2 border border-gray-300 rounded-md mt-1" onchange="handleUpdateAction('${action.id}', 'category', this.value)">${ACTION_CATEGORIES.map(c => `<option value="${c}" ${action.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>
              <div><label class="text-sm font-medium text-gray-600">שכבת MTSS</label><select class="w-full p-2 border border-gray-300 rounded-md mt-1" onchange="handleUpdateAction('${action.id}', 'tier', this.value)">${TIER_OPTIONS.map(c => `<option value="${c}" ${action.tier === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>
              <div><label class="text-sm font-medium text-gray-600">קהל יעד</label><select class="w-full p-2 border border-gray-300 rounded-md mt-1" onchange="handleUpdateAction('${action.id}', 'targetAudience', this.value)">${TARGET_AUDIENCE_OPTIONS.map(c => `<option value="${c}" ${action.targetAudience === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>
              <div><label class="text-sm font-medium text-gray-600">תדירות</label><select class="w-full p-2 border border-gray-300 rounded-md mt-1" onchange="handleUpdateAction('${action.id}', 'frequency', this.value)">${FREQUENCY_OPTIONS.map(c => `<option value="${c}" ${action.frequency === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>
            </div>
          </div>
        `).join('');
        const suggestionsHtml = SUGGESTED_ACTIONS_BANK.map(sugg => `<div class="p-3 border-b hover:bg-teal-50 flex justify-between items-center"><div><p class="font-semibold text-teal-700">${escapeHtml(sugg.name)}</p><p class="text-sm text-gray-600">${escapeHtml(sugg.category)} - ${escapeHtml(sugg.tier)}</p></div><button onclick='handleAddAction(${JSON.stringify(sugg)})' class="bg-teal-500 text-white px-3 py-1 rounded-md text-sm hover:bg-teal-600">+ הוסף</button></div>`).join('');
        appContentEl.innerHTML = `<div class="grid md:grid-cols-3 gap-8"><div class="md:col-span-2"><h3 class="text-2xl font-semibold text-gray-800 mb-4">פעולות הליבה בתוכנית</h3><div id="selected-actions" class="space-y-4">${selectedActionsHtml || '<p class="text-gray-500 italic">לא נוספו פעולות.</p>'}</div><button onclick="handleAddAction()" class="mt-6 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">+ הוסף פעולה חדשה</button></div><div class="bg-gray-50 p-4 rounded-lg border"><h3 class="text-xl font-semibold text-gray-700 mb-3">מאגר הצעות לפעולות</h3><div class="suggestion-bank">${suggestionsHtml}</div></div></div>`;
        renderActionButtons();
      }

      // --- Step 5: Partners & Resources ---
      function handleAddItem(type, suggestion = {}) { const newItem = { id: `${type}_${Date.now()}`, name: suggestion.name || 'פריט חדש', category: suggestion.category || (type === 'partner' ? PARTNER_CATEGORIES[0] : RESOURCE_CATEGORIES[0]), role: suggestion.role || '', expertise: suggestion.expertise || '', details: suggestion.details || '', }; if (type === 'partner') supportPlan.partners.push(newItem); else supportPlan.resources.push(newItem); renderStep5PartnersAndResources(); }
      function handleUpdateItem(type, id, field, value) { const list = type === 'partner' ? supportPlan.partners : supportPlan.resources; const item = list.find(i => i.id === id); if (item) item[field] = value; }
      function handleRemoveItem(type, id) { if (type === 'partner') supportPlan.partners = supportPlan.partners.filter(i => i.id !== id); else supportPlan.resources = supportPlan.resources.filter(i => i.id !== id); renderStep5PartnersAndResources(); }
      function renderItemCard(type, item, categories) { const isPartner = type === 'partner'; return `<div class="item-card p-4 border rounded-lg bg-white shadow-sm space-y-3 fade-in"><div class="flex justify-between items-center"><input type="text" class="text-lg font-semibold border-b-2 border-transparent focus:border-blue-500 outline-none w-full" value="${escapeHtml(item.name)}" oninput="handleUpdateItem('${type}', '${item.id}', 'name', this.value)"><button onclick="handleRemoveItem('${type}', '${item.id}')" class="text-red-500 hover:text-red-700 font-bold text-xl">&times;</button></div><div><label class="text-sm font-medium text-gray-600">קטגוריה</label><select class="w-full p-2 border border-gray-300 rounded-md mt-1" onchange="handleUpdateItem('${type}', '${item.id}', 'category', this.value)">${categories.map(c => `<option value="${c}" ${item.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>${isPartner ? `<div><label class="text-sm font-medium text-gray-600">תפקיד</label><input type="text" class="w-full p-2 border border-gray-300 rounded-md mt-1" placeholder="מנטור, יועץ" value="${escapeHtml(item.role)}" oninput="handleUpdateItem('${type}', '${item.id}', 'role', this.value)"></div>` : `<div><label class="text-sm font-medium text-gray-600">פרטים</label><input type="text" class="w-full p-2 border border-gray-300 rounded-md mt-1" placeholder="10 שעות, 5000 שח" value="${escapeHtml(item.details)}" oninput="handleUpdateItem('${type}', '${item.id}', 'details', this.value)"></div>`}</div>`; }
      function renderSuggestionItem(type, sugg) { return `<div class="p-3 border-b hover:bg-blue-50 flex justify-between items-center"><div><p class="font-semibold text-blue-700">${escapeHtml(sugg.name)}</p><p class="text-sm text-gray-600">${escapeHtml(sugg.category)}</p></div><button onclick='handleAddItem("${type}", ${JSON.stringify(sugg)})' class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600">+ הוסף</button></div>`; }
      function renderStep5PartnersAndResources() { const partnersHtml = supportPlan.partners.map(p => renderItemCard('partner', p, PARTNER_CATEGORIES)).join(''); const resourcesHtml = supportPlan.resources.map(r => renderItemCard('resource', r, RESOURCE_CATEGORIES)).join(''); appContentEl.innerHTML = `<div class="grid lg:grid-cols-2 gap-12"><div><h3 class="text-2xl font-semibold text-gray-800 mb-4">🤝 שותפים</h3><div class="space-y-4 mb-6">${partnersHtml || '<p class="text-gray-500 italic">לא זוהו שותפים.</p>'}</div><button onclick="handleAddItem('partner')" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">+ הוסף שותף</button><div class="bg-gray-50 p-4 rounded-lg border mt-6"><h4 class="text-xl font-semibold text-gray-700 mb-3">מאגר שותפים</h4><div class="suggestion-bank">${SUGGESTED_PARTNERS_BANK.map(s => renderSuggestionItem('partner', s)).join('')}</div></div></div><div><h3 class="text-2xl font-semibold text-gray-800 mb-4">💎 משאבים</h3><div class="space-y-4 mb-6">${resourcesHtml || '<p class="text-gray-500 italic">לא הוגדרו משאבים.</p>'}</div><button onclick="handleAddItem('resource')" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">+ הוסף משאב</button><div class="bg-gray-50 p-4 rounded-lg border mt-6"><h4 class="text-xl font-semibold text-gray-700 mb-3">מאגר משאבים</h4><div class="suggestion-bank">${SUGGESTED_RESOURCES_BANK.map(s => renderSuggestionItem('resource', s)).join('')}</div></div></div></div>`; renderActionButtons(); }

      // --- Step 6: Operational Plan ---
      function handleAddTask() { supportPlan.operationalPlan.push({ id: `task_${Date.now()}`, task: '', responsible: '', startDate: '', endDate: '', status: TASK_STATUSES[0], actionId: '' }); renderStep6OperationalPlan(); }
      function handleUpdateTask(id, field, value) { const task = supportPlan.operationalPlan.find(t => t.id === id); if (task) task[field] = value; }
      function handleRemoveTask(id) { supportPlan.operationalPlan = supportPlan.operationalPlan.filter(t => t.id !== id); renderStep6OperationalPlan(); }
      function renderStep6OperationalPlan() { const tasksHtml = supportPlan.operationalPlan.map(task => `<tr class="fade-in hover:bg-gray-50"><td class="p-2 border-b"><textarea rows="2" class="w-full p-1 border border-gray-200 rounded" oninput="handleUpdateTask('${task.id}', 'task', this.value)">${escapeHtml(task.task)}</textarea></td><td class="p-2 border-b"><select class="w-full p-1 border border-gray-200 rounded" onchange="handleUpdateTask('${task.id}', 'responsible', this.value)"><option value="">בחר...</option>${supportPlan.partners.map(p => `<option value="${p.name}" ${task.responsible === p.name ? 'selected' : ''}>${escapeHtml(p.name)}</option>`).join('')}</select></td><td class="p-2 border-b"><input type="date" class="w-full p-1 border border-gray-200 rounded" value="${task.startDate}" onchange="handleUpdateTask('${task.id}', 'startDate', this.value)"></td><td class="p-2 border-b"><input type="date" class="w-full p-1 border border-gray-200 rounded" value="${task.endDate}" onchange="handleUpdateTask('${task.id}', 'endDate', this.value)"></td><td class="p-2 border-b"><select class="w-full p-1 border border-gray-200 rounded" onchange="handleUpdateTask('${task.id}', 'status', this.value)">${TASK_STATUSES.map(s => `<option value="${s}" ${task.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></td><td class="p-2 border-b"><select class="w-full p-1 border border-gray-200 rounded" onchange="handleUpdateTask('${task.id}', 'actionId', this.value)"><option value="">בחר...</option>${supportPlan.coreActions.map(a => `<option value="${a.id}" ${task.actionId === a.id ? 'selected' : ''}>${escapeHtml(a.name)}</option>`).join('')}</select></td><td class="p-2 border-b text-center"><button onclick="handleRemoveTask('${task.id}')" class="text-red-500 hover:text-red-700">&times;</button></td></tr>`).join(''); appContentEl.innerHTML = `<h3 class="text-2xl font-semibold text-gray-800 mb-4">📋 תוכנית עבודה אופרטיבית</h3><div class="overflow-x-auto"><table class="w-full text-sm text-right"><thead class="bg-gray-100"><tr><th class="p-2">משימה</th><th class="p-2">אחראי</th><th class="p-2">התחלה</th><th class="p-2">סיום</th><th class="p-2">סטטוס</th><th class="p-2">קשור לפעולה</th><th class="p-2">הסר</th></tr></thead><tbody>${tasksHtml || '<tr><td colspan="7" class="text-center p-4 text-gray-500">לא הוגדרו משימות.</td></tr>'}</tbody></table></div><button onclick="handleAddTask()" class="mt-6 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">+ הוסף משימה</button>`; renderActionButtons(); }

      // --- Step 7: Final Combined Report ---
      function generateFullReportHTML() { const interventionPart = `<div style="margin-bottom:20px;padding:15px;border:1px solid #b2dfdb;border-radius:8px;background:#e0f2f1;"><h3 style="color:#00796b;margin-top:0;">שאלת הסוגייה:</h3><p style="margin-bottom:0;">${escapeHtml(extractedData?.main_issue_question) || 'לא הוגדרה.'}</p></div><div style="margin-bottom:20px;padding:15px;border:1px solid #b2dfdb;border-radius:8px;background:#e0f2f1;"><h3 style="color:#00796b;margin-top:0;">מטרה מרכזית:</h3><p style="margin-bottom:0;">${escapeHtml(interventionPlan.mainGoal) || 'לא הוגדרה.'}</p></div>`; const actionsHtml = supportPlan.coreActions.length ? supportPlan.coreActions.map(a => `<div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; background: #f9f9f9; border-radius: 5px;"><h4 style="color:#00796b;margin-top:0;">${escapeHtml(a.name)}</h4><p><strong>תיאור:</strong> ${escapeHtml(a.description)}</p><p><strong>קטגוריה:</strong> ${escapeHtml(a.category)} | <strong>שכבת MTSS:</strong> ${escapeHtml(a.tier)} | <strong>תדירות:</strong> ${escapeHtml(a.frequency)}</p></div>`).join('') : '<p>לא הוגדרו פעולות ליבה.</p>'; const partnersHtml = supportPlan.partners.length ? `<ul>${supportPlan.partners.map(p => `<li><strong>${escapeHtml(p.name)}</strong> (${escapeHtml(p.category)}): ${escapeHtml(p.role)}</li>`).join('')}</ul>` : '<p>לא זוהו שותפים.</p>'; const resourcesHtml = supportPlan.resources.length ? `<ul>${supportPlan.resources.map(r => `<li><strong>${escapeHtml(r.name)}</strong> (${escapeHtml(r.category)}): ${escapeHtml(r.details)}</li>`).join('')}</ul>` : '<p>לא הוגדרו משאבים.</p>'; const tasksHtml = supportPlan.operationalPlan.length ? `<table style="width:100%; border-collapse: collapse; font-size: 12px;"><tr style="background-color: #f2f2f2; text-align: right;"><th style="padding: 8px; border: 1px solid #ddd;">משימה</th><th style="padding: 8px; border: 1px solid #ddd;">אחראי</th><th style="padding: 8px; border: 1px solid #ddd;">תאריכים</th><th style="padding: 8px; border: 1px solid #ddd;">סטטוס</th></tr>${supportPlan.operationalPlan.map(t => `<tr><td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(t.task)}</td><td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(t.responsible)}</td><td style="padding: 8px; border: 1px solid #ddd;">${t.startDate || ''} - ${t.endDate || ''}</td><td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(t.status)}</td></tr>`).join('')}</table>` : '<p>לא הוגדרה תוכנית עבודה.</p>'; return `<!DOCTYPE html><html dir="rtl" lang="he"><head><meta charset="UTF-8"><title>דוח תוכנית התערבות וליווי</title><style>ul{padding-right:20px;}</style></head><body style="font-family:Arial,sans-serif;direction:rtl;line-height:1.6;padding:20px;max-width:900px;margin:auto;"><h1 style="text-align:center;color:#00796b;">דוח מסכם: תוכנית התערבות וליווי MTSS</h1><h2 style="color:#004d40;border-bottom:2px solid #00796b;">חלק א': תוכנית ההתערבות</h2>${interventionPart}<hr style="margin: 40px 0;"><h2 style="color:#004d40;border-bottom:2px solid #00796b;">חלק ב': תוכנית הליווי האופרטיבית</h2><div style="margin-top:20px;"><h3 style="color:#00695c;">פעולות ליבה</h3>${actionsHtml}</div><div style="margin-top:20px;"><h3 style="color:#00695c;">שותפים למהלך</h3>${partnersHtml}</div><div style="margin-top:20px;"><h3 style="color:#00695c;">משאבים נדרשים</h3>${resourcesHtml}</div><div style="margin-top:20px;"><h3 style="color:#00695c;">תוכנית עבודה אופרטיבית</h3>${tasksHtml}</div></body></html>`; }
      function downloadFullReport() { const htmlContent = generateFullReportHTML(); const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `דוח_ליווי_MTSS_${(extractedData?.challenge || 'כללי').replace(/[\s"']/g, '_')}.html`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); displayMessage('success', 'הדוח המלא נוצר והורד בהצלחה!'); }
      function renderStep7FinalReport() { appContentEl.innerHTML = `<div class="text-center space-y-6"><h2 class="text-3xl font-semibold text-teal-700">✅ כל השלבים הושלמו!</h2><p class="text-lg text-gray-600">התוכנית המלאה, הכוללת את הגדרת ההתערבות ואת תוכנית הליווי, מוכנה להורדה.</p><button onclick="downloadFullReport()" class="px-8 py-4 bg-blue-600 text-white text-lg font-semibold rounded-lg shadow-xl hover:bg-blue-700 transition duration-150 transform hover:scale-105">📄 הורד דוח מסכם ומלא</button></div>`; renderActionButtons(); }

      // --- CORE APP LOGIC ---
      function renderActionButtons() {
        if (currentStep === 0) { actionButtonsContainerEl.innerHTML = ''; return; }
        let buttonsHtml = `<button onclick="goBack()" class="px-8 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition transform hover:scale-105">→ חזור</button>`;
        if (currentStep < STEP_DESCRIPTIONS.length - 1) {
            let nextStepButtonText = `המשך לשלב הבא →`;
            if (currentStep === 2) nextStepButtonText = 'המשך לבניית תוכנית ליווי →';
            if (currentStep === 6) nextStepButtonText = 'המשך לסיכום סופי →';
            let disabled = false;
            // Add validation checks for each step
            if (currentStep === 1 && (interventionPlan.mainGoal.trim() === '' || interventionPlan.smartObjectives.every(s => s.trim() === ''))) disabled = true;
            if (currentStep === 4 && supportPlan.coreActions.length === 0) disabled = true;
            if (currentStep === 5 && (supportPlan.partners.length === 0 || supportPlan.resources.length === 0)) disabled = true;
            if (currentStep === 6 && supportPlan.operationalPlan.length === 0) disabled = true;
            buttonsHtml += `<button onclick="if(!this.disabled) moveToStep(currentStep + 1)" ${disabled ? 'disabled' : ''} class="px-8 py-3 bg-gradient-to-r from-teal-500 to-green-600 text-white font-semibold rounded-lg shadow-md hover:from-teal-600 hover:to-green-700 transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">${nextStepButtonText}</button>`;
        }
        if (currentStep === STEP_DESCRIPTIONS.length - 1) {
            buttonsHtml += `<button onclick="startNew()" class="px-8 py-3 bg-amber-500 text-white font-semibold rounded-lg shadow-md hover:bg-amber-600 transition transform hover:scale-105">🔄 התחל תוכנית חדשה</button>`;
        }
        actionButtonsContainerEl.innerHTML = buttonsHtml;
      }
      
      function renderApp() {
        stepDescriptionEl.textContent = STEP_DESCRIPTIONS[currentStep];
        loadingIndicatorEl.style.display = loading ? 'flex' : 'none';
        errorMessageEl.style.display = error ? 'block' : 'none'; errorMessageEl.textContent = error || '';
        successMessageEl.style.display = success ? 'block' : 'none'; successMessageEl.textContent = success || '';
        switch (currentStep) {
          case 0: renderStep0Upload(); break;
          case 1: renderStep1Goals(); break;
          case 2: renderStep2MTSS(); break;
          case 3: renderStep3Report(); break;
          case 4: renderStep4Actions(); break;
          case 5: renderStep5PartnersAndResources(); break;
          case 6: renderStep6OperationalPlan(); break;
          case 7: renderStep7FinalReport(); break;
          default: appContentEl.innerHTML = 'שלב לא ידוע.';
        }
        renderActionButtons();
      }

      // Initial Load
      document.addEventListener('DOMContentLoaded', renderApp);
    </script>
</body>
</html>