<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×ª×•×— ×¡×™×‘×•×ª ×©×•×¨×© - ×›×œ×™ 5 Why's</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #2d3436;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
        }

        .file-upload { /* ×©×™× ×œ×‘ ×©×”-input ×›×‘×¨ ×œ× × ××¦× ×›××Ÿ ×™×©×™×¨×•×ª */
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            transition: all 0.3s ease;
            background: #f8f9ff;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .file-upload:hover {
            border-color: #764ba2;
            background: #f0f1ff;
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #636e72;
        }

        .btn-secondary:hover {
            background: #2d3436;
        }
        
        .action-buttons { 
            display: flex;
            justify-content: center;
            gap: 15px;
            align-items: center;
            margin-top: 20px;
        }

        .step-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
        }

        .step-section.active {
            display: block;
        }

        .step-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .challenges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
            gap: 20px;
            margin-bottom: 20px;
        }

        .challenge-card {
            background: #f8f9fa;
            padding: 20px;
            padding-top: 45px; 
            border-radius: 12px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex; 
            flex-direction: column; 
        }

        .challenge-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .challenge-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }
        
        .challenge-badges { 
            position: absolute;
            top: 10px;
            left: 10px; 
            right: auto; 
            display: flex;
            gap: 8px;
        }

        .frequency-badge { 
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
            color: white;
        }
        .frequency-limited { background-color: #27ae60; } 
        .frequency-wide { background-color: #f39c12; }    
        .frequency-very-wide { background-color: #e74c3c; } 


        .challenge-title {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #2d3436;
        }

        .challenge-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #636e72;
        }

        .challenge-description {
            font-size: 0.95em;
            line-height: 1.5;
            color: #2d3436;
            flex-grow: 1; 
        }
        
        .why-analysis {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .why-level {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border-right: 5px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .why-level h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .why-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.3s ease;
        }

        .why-input:focus {
            border-color: #667eea;
            outline: none;
        }

        .suggestion-box {
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .suggestion-box label {
            font-weight: 600;
            color: #636e72;
            font-size: 0.9em;
        }

        .suggestion-select {
            flex-grow: 1;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background-color: #f8f9ff;
            cursor: pointer;
        }

        .factors-mapping {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .factor-category {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .factor-category h4 {
            color: #2d3436;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .factor-item {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-right: 3px solid #667eea;
            transition: all 0.3s ease;
        }

        .factor-item:hover {
            background: #e9ecef;
            transform: translateX(-2px);
        }

        .influence-level {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }

        .high-influence {
            background: #ff6b6b;
            color: white;
        }

        .medium-influence {
            background: #feca57;
            color: #2d3436;
        }

        .low-influence {
            background: #48dbfb;
            color: white;
        }

        .connections-map {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .connection-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .connection-arrow {
            margin: 0 15px;
            font-size: 1.5em;
            color: #667eea;
        }

        .summary-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .summary-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #667eea;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            display: none;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            display: none;
        }

        .progress-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 20px;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            font-weight: 600;
        }

        .progress-step.active {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
        }

        .progress-step.completed {
            background: #27ae60;
            color: white;
        }

        .file-info {
            background: #dff0d8;
            border: 1px solid #d6e9c6;
            color: #3c763d;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: right;
        }

        @media (max-width: 768px) {
            .challenges-grid {
                grid-template-columns: 1fr;
            }
            
            .factors-mapping {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }

            .progress-indicator {
                flex-wrap: wrap;
                gap: 10px;
            }

            .progress-step {
                padding: 8px 12px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” × ×™×ª×•×— ×¡×™×‘×•×ª ×©×•×¨×©</h1>
            <p>×›×œ×™ ××ª×§×“× ×œ× ×™×ª×•×— ×”××ª×’×¨×™× ×•×”×’×•×¨××™× ×”×¢××•×§×™× ×‘×××¦×¢×•×ª ×©×™×˜×ª 5 Why's</p>
        </div>

        <div class="progress-indicator">
            <div class="progress-step active" id="step1Progress">
                <span>1ï¸âƒ£</span>
                <span>×”×¢×œ××ª × ×ª×•× ×™×</span>
            </div>
            <div class="progress-step" id="step2Progress">
                <span>2ï¸âƒ£</span>
                <span>×‘×—×™×¨×ª ××ª×’×¨</span>
            </div>
            <div class="progress-step" id="step3Progress">
                <span>3ï¸âƒ£</span>
                <span>× ×™×ª×•×— 5 Why's</span>
            </div>
            <div class="progress-step" id="step4Progress">
                <span>4ï¸âƒ£</span>
                <span>××™×¤×•×™ ×’×•×¨××™×</span>
            </div>
            <div class="progress-step" id="step5Progress">
                <span>5ï¸âƒ£</span>
                <span>×¡×™×›×•× ×•×”××œ×¦×•×ª</span>
            </div>
        </div>

        <!-- ×©×œ×‘ 1: ×”×¢×œ××ª × ×ª×•× ×™× -->
        <div class="step-section active" id="step1">
            <div class="upload-section">
                <h2>ğŸ“Š ×”×¢×œ××ª ×“×•×— × ×™×ª×•×— ××™×¤×•×™</h2>
                <p style="margin-bottom: 20px; color: #636e72;">×”×¢×œ×” ××ª ×“×•×— ×”××™×¤×•×™ ×”××§×™×£ ××”×©×œ×‘ ×”×§×•×“× ×›×“×™ ×œ×”××©×™×š ×‘× ×™×ª×•×— ×¡×™×‘×•×ª ×”×©×•×¨×©</p>
                
                <div class="file-upload" id="fileUploadArea">
                    <div class="upload-icon">ğŸ“„</div>
                    <h3>×œ×—×¥ ×›×“×™ ×œ×”×¢×œ×•×ª ×§×•×‘×¥ ×“×•×—</h3>
                    <p>×ª×•××š ×‘×§×‘×¦×™ HTML, TXT, JS ×•×§×‘×¦×™ ×˜×§×¡×˜ ××”×©×œ×‘×™× ×”×§×•×“××™×</p>
                    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                        ğŸ’¡ <strong>×˜×™×¤:</strong> ×”××¤×œ×™×§×¦×™×” ×ª×–×”×” ××•×˜×•××˜×™×ª ××ª ×¡×•×’ ×”×§×•×‘×¥ ×•×ª×—×œ×¥ ××ª×’×¨×™× ×‘×”×ª××
                    </p>
                </div>

                <div id="fileInfo" class="file-info" style="display: none;"></div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="loadDemoData()">
                        ğŸ¯ ×”×©×ª××© ×‘× ×ª×•× ×™ ×“××• ×œ×”×“×’××”
                    </button>
                </div>
            </div>
        </div>

        <div id="loadingMessage" class="loading" style="display: none;">
            â³ ××¢×‘×“ ××ª ×”×“×•×— ×•××—×œ×¥ ××ª ×”××ª×’×¨×™×...
        </div>

        <div id="errorMessage" class="error"></div>
        <div id="successMessage" class="success"></div>

        <!-- ×©×œ×‘ 2: ×‘×—×™×¨×ª ××ª×’×¨ -->
        <div class="step-section" id="step2">
            <div class="step-header">
                <h2>ğŸ¯ ×‘×—×™×¨×ª ×”××ª×’×¨ ×”××¨×›×–×™ ×œ× ×™×ª×•×—</h2>
                <p>×‘×—×¨ ××ª ×”××ª×’×¨ ×©×‘×¨×¦×•× ×š ×œ× ×ª×— ×œ×¢×•××§ ×‘×××¦×¢×•×ª ×©×™×˜×ª 5 Why's</p>
            </div>
            <div id="challengesGrid" class="challenges-grid"></div>
            <div class="action-buttons">
                 <button class="btn btn-secondary" onclick="goBack()">â†’ ×—×–×•×¨ ××—×•×¨×”</button>
                <button class="btn" onclick="proceedToAnalysis()" id="proceedBtn" disabled>
                    ×”××©×š ×œ× ×™×ª×•×— 5 Why's â†
                </button>
            </div>
        </div>

        <!-- ×©×œ×‘ 3: × ×™×ª×•×— 5 Why's -->
        <div class="step-section" id="step3">
            <div class="step-header">
                <h2>ğŸ¤” × ×™×ª×•×— 5 Why's</h2>
                <p id="selectedChallengeTitle">×”××ª×’×¨ ×”× ×‘×—×¨: </p>
            </div>
            <div class="why-analysis">
                <div class="why-level">
                    <h3>ğŸ¯ ×”×ª×¡××™×Ÿ ×”× ×¦×¤×” (××” ×× ×• ×¨×•××™× ×‘×©×˜×—?)</h3>
                    <textarea class="why-input" id="symptom" placeholder="×ª××¨ ××ª ×”×ª×¡××™× ×™× ×”× ×¦×¤×™× ×‘×©×˜×— - ××” ××ª×” ×¨×•××” ×‘×¤×•×¢×œ?"></textarea>
                </div>
                
                <div class="why-level">
                    <h3>â“ ×œ××” 1: ××“×•×¢ ×–×” ×§×•×¨×”?</h3>
                    <textarea class="why-input" id="why1" placeholder="××” ×”×’×•×¨××™× ×”××™×™×“×™×™× ×œ×ª×¡××™× ×™× ×©××ª×” ×¨×•××”?"></textarea>
                    <div class="suggestion-box">
                        <label for="why1-select">×”×¦×¢×•×ª ×œ××™×œ×•×™:</label>
                        <select id="why1-select" class="suggestion-select">
                            <option value="">×‘×—×¨ ×”×¦×¢×” ×œ×”×•×¡×¤×”...</option>
                        </select>
                    </div>
                </div>
                
                <div class="why-level">
                    <h3>â“ ×œ××” 2: ××“×•×¢ ×”×’×•×¨××™× ×”××™×™×“×™×™× ×§×™×™××™×?</h3>
                    <textarea class="why-input" id="why2" placeholder="××” ×’×•×¨× ×œ×’×•×¨××™× ×”××™×™×“×™×™× ×©×–×™×”×™×ª?"></textarea>
                    <div class="suggestion-box">
                        <label for="why2-select">×”×¦×¢×•×ª ×œ××™×œ×•×™:</label>
                        <select id="why2-select" class="suggestion-select">
                            <option value="">×‘×—×¨ ×”×¦×¢×” ×œ×”×•×¡×¤×”...</option>
                        </select>
                    </div>
                </div>
                
                <div class="why-level">
                    <h3>â“ ×œ××” 3: ××“×•×¢ ×”×‘×¢×™×•×ª ×”××¢×¨×›×ª×™×•×ª × ××©×›×•×ª?</h3>
                    <textarea class="why-input" id="why3" placeholder="××” ×”×’×•×¨××™× ×”××¢×¨×›×ª×™×™× ×”×¢××•×§×™× ×™×•×ª×¨?"></textarea>
                     <div class="suggestion-box">
                        <label for="why3-select">×”×¦×¢×•×ª ×œ××™×œ×•×™:</label>
                        <select id="why3-select" class="suggestion-select">
                            <option value="">×‘×—×¨ ×”×¦×¢×” ×œ×”×•×¡×¤×”...</option>
                        </select>
                    </div>
                </div>
                
                <div class="why-level">
                    <h3>â“ ×œ××” 4: ××“×•×¢ ×”×’×•×¨××™× ×”××‘× ×™×™× ×§×™×™××™×?</h3>
                    <textarea class="why-input" id="why4" placeholder="××” ×”×’×•×¨××™× ×”××‘× ×™×™× ×•×”××¨×’×•× ×™×™×?"></textarea>
                    <div class="suggestion-box">
                        <label for="why4-select">×”×¦×¢×•×ª ×œ××™×œ×•×™:</label>
                        <select id="why4-select" class="suggestion-select">
                            <option value="">×‘×—×¨ ×”×¦×¢×” ×œ×”×•×¡×¤×”...</option>
                        </select>
                    </div>
                </div>
                
                <div class="why-level">
                    <h3>ğŸ¯ ×œ××” 5: ××” ×”×’×•×¨××™× ×”×©×•×¨×©×™×™× ×”×¢××•×§×™× ×‘×™×•×ª×¨?</h3>
                    <textarea class="why-input" id="why5" placeholder="××” ×’×•×¨××™ ×”×©×•×¨×© ×”×¢××•×§×™× ×‘×™×•×ª×¨ ×©× ×™×ª×Ÿ ×œ×”×©×¤×™×¢ ×¢×œ×™×”×?"></textarea>
                    <div class="suggestion-box">
                        <label for="why5-select">×”×¦×¢×•×ª ×œ××™×œ×•×™:</label>
                        <select id="why5-select" class="suggestion-select">
                            <option value="">×‘×—×¨ ×”×¦×¢×” ×œ×”×•×¡×¤×”...</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="goBack()">â†’ ×—×–×•×¨ ××—×•×¨×”</button>
                <button class="btn" onclick="proceedToMapping()">×”××©×š ×œ××™×¤×•×™ ×’×•×¨××™× â†</button>
            </div>
        </div>


        <!-- ×©×œ×‘ 4: ××™×¤×•×™ ×’×•×¨××™× -->
        <div class="step-section" id="step4">
            <div class="step-header">
                <h2>ğŸ—ºï¸ ××™×¤×•×™ ×•×¡×™×•×•×’ ×’×•×¨××™×</h2>
                <p>×¡×•×•×’ ××ª ×”×’×•×¨××™× ×©×–×™×”×™×ª ×œ×¤×™ ×™×›×•×œ×ª ×”×©×¤×¢×” ×•×§×©×¨×™× ×”×“×“×™×™×</p>
            </div>
            
            <div class="factors-mapping">
                <div class="factor-category">
                    <h4>ğŸ”´ ×’×•×¨××™× ×‘×¢×œ×™ ×”×©×¤×¢×” ×’×‘×•×”×”</h4>
                    <p style="font-size: 0.9em; color: #636e72; margin-bottom: 15px;">×’×•×¨××™× ×©× ×™×ª×Ÿ ×œ×”×©×¤×™×¢ ×¢×œ×™×”× ×‘××•×¤×Ÿ ×™×©×™×¨ ×•×™×© ×œ×”× ×”×©×¤×¢×” ××©××¢×•×ª×™×ª</p>
                    <div id="highInfluenceFactors" class="factors-container"></div>
                </div>
                
                <div class="factor-category">
                    <h4>ğŸŸ¡ ×’×•×¨××™× ×‘×¢×œ×™ ×”×©×¤×¢×” ×‘×™× ×•× ×™×ª</h4>
                    <p style="font-size: 0.9em; color: #636e72; margin-bottom: 15px;">×’×•×¨××™× ×©× ×™×ª×Ÿ ×œ×”×©×¤×™×¢ ×¢×œ×™×”× ×‘××•×¤×Ÿ ×—×œ×§×™ ××• ×¢×§×™×£</p>
                    <div id="mediumInfluenceFactors" class="factors-container"></div>
                </div>
                
                <div class="factor-category">
                    <h4>ğŸ”µ ×’×•×¨××™× ×‘×¢×œ×™ ×”×©×¤×¢×” × ××•×›×”</h4>
                    <p style="font-size: 0.9em; color: #636e72; margin-bottom: 15px;">×’×•×¨××™× ×©×§×©×” ×œ×”×©×¤×™×¢ ×¢×œ×™×”× ××• ×©×”×©×¤×¢×ª× ××•×’×‘×œ×ª</p>
                    <div id="lowInfluenceFactors" class="factors-container"></div>
                </div>
            </div>

            <div class="connections-map">
                <h3>ğŸ”— ×§×©×¨×™× ×‘×™×Ÿ ×’×•×¨××™×</h3>
                <p style="margin-bottom: 15px; color: #636e72;">×–×™×”×•×™ ×§×©×¨×™× ×•×”×©×¤×¢×•×ª ×”×“×“×™×•×ª ×‘×™×Ÿ ×”×’×•×¨××™× ×”×©×•× ×™×</p>
                <div id="connectionsContainer"></div>
            </div>

             <div class="action-buttons">
                <button class="btn btn-secondary" onclick="goBack()">â†’ ×—×–×•×¨ ××—×•×¨×”</button>
                <button class="btn" onclick="generateSummary()">×¦×•×¨ ×¡×™×›×•× ×•×”××œ×¦×•×ª â†</button>
            </div>
        </div>

        <!-- ×©×œ×‘ 5: ×¡×™×›×•× ×•×”××œ×¦×•×ª -->
        <div class="step-section" id="step5">
            <div class="step-header">
                <h2>ğŸ“‹ ×¡×™×›×•× × ×™×ª×•×— ×¡×™×‘×•×ª ×”×©×•×¨×©</h2>
                <p>×ª×•×‘× ×•×ª ××¨×›×–×™×•×ª ×•×”××œ×¦×•×ª ×œ×¤×¢×•×œ×” ×¢×œ ×‘×¡×™×¡ ×”× ×™×ª×•×—</p>
            </div>
            
            <div class="summary-section">
                <h3>ğŸ¯ ×”××ª×’×¨ ×©× ×•×ª×—</h3>
                <div id="challengeSummary"></div>
                
                <div class="summary-grid">
                    <div class="summary-card">
                        <h4>ğŸ”´ ×’×•×¨××™ ×©×•×¨×© ×¢×™×§×¨×™×™×</h4>
                        <div id="rootCausesSummary"></div>
                    </div>
                    
                    <div class="summary-card">
                        <h4>âš¡ ×’×•×¨××™× ×‘×¢×“×™×¤×•×ª ×’×‘×•×”×”</h4>
                        <div id="highPriorityFactors"></div>
                    </div>
                    
                    <div class="summary-card">
                        <h4>ğŸ”— ×§×©×¨×™× ××¨×›×–×™×™×</h4>
                        <div id="keyConnections"></div>
                    </div>
                    
                    <div class="summary-card">
                        <h4>ğŸ’¡ ×”××œ×¦×•×ª ×œ×¤×¢×•×œ×”</h4>
                        <div id="actionRecommendations"></div>
                    </div>
                </div>
            </div>

             <div class="action-buttons">
                <button class="btn btn-secondary" onclick="goBack()">â†’ ×—×–×•×¨ ××—×•×¨×”</button>
                <button class="btn" onclick="downloadAnalysis()">ğŸ“„ ×”×•×¨×“ ×“×•×— × ×™×ª×•×— ×¡×™×‘×•×ª ×©×•×¨×©</button>
                <button class="btn btn-secondary" onclick="startNewAnalysis()">ğŸ”„ ×”×ª×—×œ × ×™×ª×•×— ×—×“×©</button>
            </div>
        </div>
    </div>

    <script>
        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        let analysisData = null;
        let selectedChallenge = null;
        let currentStep = 1;
        let whyAnalysis = {};
        let factorsMapping = {
            high: [],
            medium: [],
            low: []
        };
        let connections = [];

        // ×××’×¨ ×”×¦×¢×•×ª ×œ××™×œ×•×™ × ×™×ª×•×— 5 Why's
        const whySuggestions = {
            why1: [
                "×©×™×˜×•×ª ×”×•×¨××” ××™× ×Ÿ ××•×ª×××•×ª ×œ×©×•× ×•×ª ×”×ª×œ××™×“×™×",
                "×¤×¢×¨×™× ×‘×™×“×¢ ×§×•×“× ×©×œ ×ª×œ××™×“×™× ×”××§×©×™× ×¢×œ ×”×ª×§×“××•×ª",
                "×—×•×¡×¨ ××•×˜×™×‘×¦×™×” ×•×¢× ×™×™×Ÿ ×©×œ ×ª×œ××™×“×™× ×‘×—×•××¨ ×”× ×œ××“",
                "×”×ª× ×”×’×•×ª ×××ª×’×¨×ª ×‘×›×™×ª×” ×”××¤×¨×™×¢×” ×œ×¨×¦×£ ×”×œ××™×“×”",
                "×¦×™×¤×™×•×ª × ××•×›×•×ª ×©×œ ×”××•×¨×™× ××”×ª×œ××™×“×™×"
            ],
            why2: [
                "×”×™×¢×“×¨ ×”×›×©×¨×” ××§×¦×•×¢×™×ª ×¨×œ×•×•× ×˜×™×ª ×œ××•×¨×™× ×‘×ª×—×•×",
                "×—×•×¡×¨ ×‘×›×œ×™× ×“×™×“×§×˜×™×™× ×•×˜×›× ×•×œ×•×’×™×™× ××ª××™××™×",
                "×¢×•××¡ ×¨×‘ ×¢×œ ×”××•×¨×™× ×©××™× ×• ×××¤×©×¨ ×ª×›× ×•×Ÿ ××¢××™×§",
                "×”×™×¢×“×¨ ×©×’×¨×•×ª ×¢×‘×•×“×” ×©×œ ×œ××™×“×ª ×¢××™×ª×™× ×•×©×™×ª×•×£ ×¤×¢×•×œ×”",
                "××¢×¨×›×ª ×”×¢×¨×›×” ×©××™× ×” ××¡×¤×§×ª ××©×•×‘ ××¤×§×˜×™×‘×™ ×œ××•×¨×™×"
            ],
            why3: [
                "×ª×¨×‘×•×ª ××¨×’×•× ×™×ª ×©××™× ×” ××¢×•×“×“×ª ×—×“×©× ×•×ª ×•×™×•×–××”",
                "×ª×•×›× ×™×ª ×œ×™××•×“×™× ×¢××•×¡×” ×©××™× ×” ×××¤×©×¨×ª ×œ××™×“×” ×œ×¢×•××§",
                "×”×™×¢×“×¨ ××¢×¨×›×ª ×ª××™×›×” ×œ×ª×œ××™×“×™× ××ª×§×©×™×",
                "×—×•×¡×¨ ××—×™×“×•×ª ×‘×¤×¨×§×˜×™×§×•×ª ×”×”×•×¨××” ×‘×™×Ÿ ×”××•×¨×™×",
                "×§×©×¨ ×¨×•×¤×£ ×¢× ×”×•×¨×™ ×”×ª×œ××™×“×™× ×•×—×•×¡×¨ ××¢×•×¨×‘×•×ª×"
            ],
            why4: [
                "××“×™× ×™×•×ª ×‘×™×ª ×¡×¤×¨×™×ª ×œ× ×‘×¨×•×¨×” ×‘× ×•×’×¢ ×œ×˜×™×¤×•×œ ×‘××ª×’×¨",
                "×”×™×¢×“×¨ ×× ×”×™×’×•×ª ×¤×“×’×•×’×™×ª ×—×–×§×” ×•××•×‘×™×œ×”",
                "×ª×”×œ×™×›×™ ×§×‘×œ×ª ×”×—×œ×˜×•×ª ××™× × ××‘×•×¡×¡×™× ×¢×œ × ×ª×•× ×™×",
                "××‘× ×” ××¢×¨×›×ª ×”×©×¢×•×ª ×©××™× ×• ×ª×•××š ×‘×œ××™×“×” ×’××™×©×”",
                "×”×§×¦××ª ××©××‘×™× ×œ× ××¡×¤×§×ª ×œ×ª×—×•× ×”× ×“×¨×©"
            ],
            why5: [
                "×ª×¤×™×¡×•×ª ×•×××•× ×•×ª ××’×‘×™×œ×•×ª ×©×œ ×”×¦×•×•×ª ×”×—×™× ×•×›×™",
                "×œ×—×¦×™× ×—×™×¦×•× ×™×™× ×××¢×¨×›×ª ×”×—×™× ×•×š (××‘×—× ×™×, ×“×¨×™×©×•×ª ××©×¨×“ ×”×—×™× ×•×š)",
                "××—×¡×•×¨ ×‘×ª×§×¦×•×‘ ×™×™×¢×•×“×™ ×œ×˜×•×•×— ××¨×•×š",
                "×¤×¢×¨×™× ×—×‘×¨×ª×™×™×-×›×œ×›×œ×™×™× ×”××©×¤×™×¢×™× ×¢×œ ×”×§×”×™×œ×” ×”×‘×™×ª-×¡×¤×¨×™×ª",
                "×—×•×¡×¨ ×—×–×•×Ÿ ×‘×™×ª ×¡×¤×¨×™ ××©×•×ª×£ ×•×‘×¨×•×¨"
            ]
        };

        // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨
        function showLoading(show) {
            document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 6000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 4000);
        }

        function showFileInfo(fileName, challengesCount, status = '×”×•×©×œ×') {
            const fileInfo = document.getElementById('fileInfo');
            const statusColor = status === '×©×’×™××”' ? '#d32f2f' : status.includes('×˜×•×¢×Ÿ') ? '#f57c00' : '#388e3c';
            const statusIcon = status === '×©×’×™××”' ? 'âŒ' : status.includes('×˜×•×¢×Ÿ') ? 'â³' : 'âœ…';
            
            fileInfo.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2em;">${statusIcon}</span>
                    <div>
                        <strong>ğŸ“ ×§×•×‘×¥:</strong> ${fileName}<br>
                        <strong>ğŸ“Š ×¡×˜×˜×•×¡:</strong> <span style="color: ${statusColor}; font-weight: bold;">${status}</span><br>
                        ${challengesCount > 0 ? `<strong>ğŸ¯ ××ª×’×¨×™×:</strong> ${challengesCount} ×–×•×”×• ×œ× ×™×ª×•×—` : (status !== '×˜×•×¢×Ÿ...' && !status.toLowerCase().includes('×©×’×™××”') ? '×œ× ×–×•×”×• ××ª×’×¨×™× ×‘×§×•×‘×¥.' : '')}
                    </div>
                </div>
            `;
            fileInfo.style.display = 'block';
        }
        
        // --- START OF MODIFIED handleFileUpload (for dynamic input) ---
        function handleFileUpload(event) { // ×”-event ×›××Ÿ ×”×•× ××”-input ×”×“×™× ××™
            const dynamicFileInput = event.target; // ×–×” ×”××™× ×¤×•×˜ ×”×“×™× ××™ ×©×™×¦×¨× ×•
            
            if (!dynamicFileInput.files || dynamicFileInput.files.length === 0) {
                console.log('×œ× × ×‘×—×¨×• ×§×‘×¦×™×.');
                if (dynamicFileInput) dynamicFileInput.remove(); // ×”×¡×¨×ª ×”××™× ×¤×•×˜ ×”×“×™× ××™
                return;
            }
            
            const file = dynamicFileInput.files[0];

            console.log('×§×•×‘×¥ × ×‘×—×¨:', file.name, '×’×•×“×œ:', file.size, '×¡×•×’:', file.type);

            if (file.size === 0) {
                showError('×”×§×•×‘×¥ ×¨×™×§. ×× × ×‘×—×¨ ×§×•×‘×¥ ×ª×§×™×Ÿ.');
                if (dynamicFileInput) dynamicFileInput.remove();
                return;
            }

            const fileName = file.name.toLowerCase();
            const validExtensions = ['.html', '.htm', '.txt', '.js'];
            const hasValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
            
            if (!hasValidExtension && !file.type.includes('text') && !file.type.includes('html')) {
                showError('×”×§×•×‘×¥ ×œ× × ×ª××š. ×× × ×”×¢×œ×” ×§×•×‘×¥ HTML, TXT ××• JS.');
                if (dynamicFileInput) dynamicFileInput.remove();
                return;
            }

            showLoading(true);
            showFileInfo(file.name, 0, '×˜×•×¢×Ÿ...');
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                console.log('×§×•×‘×¥ × ×§×¨× ×‘×”×¦×œ×—×”, ××•×¨×š ×ª×•×›×Ÿ:', e.target.result.length);
                try {
                    const content = e.target.result;
                    parseFileContent(content, file.name); 
                } catch (error) {
                    console.error('×©×’×™××” ×‘×¢×™×‘×•×“ ×œ××—×¨ ×§×¨×™××”:', error);
                    showError('×©×’×™××” ×‘×¢×™×‘×•×“ ×”×§×•×‘×¥: ' + error.message);
                    showLoading(false);
                } finally {
                    // ×—×©×•×‘ ×œ×”×¡×™×¨ ××ª ×”-input ×”×“×™× ××™ ×›×“×™ ×œ××¤×©×¨ ×”×¢×œ××” ×—×•×–×¨×ª ×©×œ ××•×ª×• ×§×•×‘×¥
                    if (dynamicFileInput) dynamicFileInput.remove();
                }
            };
            
            reader.onerror = function(error) {
                console.error('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥:', error);
                showError('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥. ×™×™×ª×›×Ÿ ×©×”×§×•×‘×¥ ×¤×’×•× ××• ×’×“×•×œ ××“×™.');
                showLoading(false);
                if (dynamicFileInput) dynamicFileInput.remove();
            };
            
            try {
                reader.readAsText(file);
            } catch (error) {
                console.error('×©×’×™××” ×›×œ×œ×™×ª ×‘×”×¤×¢×œ×ª FileReader:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×‘×¥. ×× × × ×¡×” ×¢× ×§×•×‘×¥ ××—×¨.');
                showLoading(false);
                if (dynamicFileInput) dynamicFileInput.remove();
            }
        }
        // --- END OF MODIFIED handleFileUpload ---

        function triggerFileUpload() {
            const oldInput = document.getElementById('dynamicFileInput');
            if (oldInput) {
                oldInput.removeEventListener('change', handleFileUpload);
                oldInput.remove();
            }

            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.id = 'dynamicFileInput';
            fileInput.accept = ".html,.htm,.txt,.js,text/html,text/plain";
            fileInput.style.display = 'none'; 
            
            fileInput.addEventListener('change', handleFileUpload); 
            
            document.body.appendChild(fileInput); 
            fileInput.click(); 
        }


        function parseFileContent(content, fileName) {
            try {
                console.log('××ª×—×™×œ ×œ×¢×‘×“ ××ª ×”×§×•×‘×¥:', fileName);
                let challenges = [];
                
                if (fileName.toLowerCase().endsWith('.js') || (content.includes('function') && content.includes('challenge'))) {
                    console.log('××–×”×” ×§×•×‘×¥ JavaScript');
                    challenges = extractFromJavaScriptFile(content);
                } else if (fileName.toLowerCase().includes('.html') || content.includes('<html')) {
                    console.log('××–×”×” ×§×•×‘×¥ HTML');
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(content, 'text/html');
                    challenges = extractChallengesFromHTML(doc);
                    
                    if (challenges.length < 2) {
                        console.log('××¢×˜ ××ª×’×¨×™× ×‘-HTML, ×× ×¡×” ×›×˜×§×¡×˜...');
                        const textChallenges = extractChallengesFromText(content);
                        challenges = [...new Set([...challenges.map(c => c.category), ...textChallenges.map(c => c.category)])]
                                     .map(cat => challenges.find(c => c.category === cat) || textChallenges.find(c => c.category === cat));
                    }
                } else {
                    console.log('××–×”×” ×§×•×‘×¥ ×˜×§×¡×˜ ×¨×’×™×œ');
                    challenges = extractChallengesFromText(content);
                }
                
                challenges = challenges.filter((challenge, index, self) => 
                    challenge && challenge.category && typeof challenge.category === 'string' &&
                    index === self.findIndex(c => c && c.category && c.category.trim().toLowerCase() === challenge.category.trim().toLowerCase())
                );
                
                console.log('×¡×š ×”×›×œ ××ª×’×¨×™× ×™×™×—×•×“×™×™× ×©× ××¦××•:', challenges.length);
                
                if (challenges.length === 0) {
                    showError(`×œ× ×”×¦×œ×—×ª×™ ×œ××¦×•× ××ª×’×¨×™× ×‘×§×•×‘×¥ ${fileName}. ×× × ×•×•×“× ×©×”×§×•×‘×¥ ××›×™×œ ××™×“×¢ ×¢×œ ××ª×’×¨×™× ×—×™× ×•×›×™×™× ××• ×”×©×ª××© ×‘× ×ª×•× ×™ ×”×“××•.`);
                    showFileInfo(fileName, 0, '×©×’×™××” - ×œ× × ××¦××• ××ª×’×¨×™×');
                    showLoading(false);
                    return;
                }

                handleSuccessfulParsing(challenges, fileName);
                
            } catch (error) {
                console.error('×©×’×™××” ×›×œ×œ×™×ª ×‘×¤×¢× ×•×—:', error);
                showError(`×©×’×™××” ×‘×¤×¢× ×•×— ×”×§×•×‘×¥ ${fileName}. ×× × ×‘×“×•×§ ×©×”×§×•×‘×¥ ×ª×§×™×Ÿ ××• ×”×©×ª××© ×‘× ×ª×•× ×™ ×”×“××•.`);
                showFileInfo(fileName, 0, '×©×’×™××”');
                showLoading(false);
            }
        }
        
        function handleSuccessfulParsing(challenges, fileName) {
            analysisData = { challenges: challenges.slice(0, 8), totalChallengesFound: challenges.length }; 
            showFileInfo(fileName, challenges.length, `×”×•×©×œ× (${challenges.length} ××ª×’×¨×™× ××•×¦×’×™×)`);
            showSuccess(`×”×§×•×‘×¥ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”! ×–×•×”×• ${analysisData.totalChallengesFound} ××ª×’×¨×™× ×¤×•×˜× ×¦×™××œ×™×™×, ××•×¦×’×™× ×¢×“ 8 ×œ× ×™×ª×•×—.`);
            showLoading(false);
            
            setTimeout(() => {
                displayChallenges();
                moveToStep(2);
            }, 1200);
        }

        function extractChallengesFromHTML(doc) {
            const challenges = [];
            const challengeSelectors = [
                'table tr td:first-child', 
                'ul > li', 'ol > li',     
                'h2', 'h3', 'h4',           
                '.challenge-item .challenge-text', 
                '.summary-card div[id^="rootCausesSummary"]', 
                '.insight-card div.insight-title' 
            ];

            challengeSelectors.forEach(selector => {
                doc.querySelectorAll(selector).forEach(el => {
                    let text = el.textContent.trim();
                    if (text && text.length > 10 && text.length < 150 && !text.toLowerCase().includes('×”×•×¨×“ ×“×•×—') && !text.toLowerCase().includes('×”××œ×¦×•×ª')) {
                        let schoolsText = '';
                        if (el.closest('tr')) { 
                           const nextCell = el.nextElementSibling;
                           if(nextCell) schoolsText = nextCell.textContent.trim();
                        } else if (el.closest('.challenge-card')) {
                           const statsEl = el.closest('.challenge-card').querySelector('.challenge-stats span:first-child');
                           if(statsEl) schoolsText = statsEl.textContent.trim();
                        }
                        const schoolsCount = extractSchoolCount(schoolsText || text); 
                        challenges.push(createChallengeObject(text, schoolsCount));
                    }
                });
            });
            
            const uniqueChallenges = challenges.filter((challenge, index, self) => 
                index === self.findIndex(c => c.category === challenge.category)
            );
            return uniqueChallenges;
        }

        function extractChallengesFromText(htmlContent) {
             const challenges = [];
            let textContent = htmlContent.replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '');
            textContent = textContent.replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '');
            textContent = textContent.replace(/<li[^>]*>([\s\S]*?)<\/li>/gi, ' $1 \n');
            textContent = textContent.replace(/<h[1-6][^>]*>([\s\S]*?)<\/h[1-6]>/gi, ' $1 \n');
            textContent = textContent.replace(/<p[^>]*>([\s\S]*?)<\/p>/gi, ' $1 \n');
            textContent = textContent.replace(/<td[^>]*>([\s\S]*?)<\/td>/gi, ' $1 | '); 
            textContent = textContent.replace(/<[^>]+>/g, ' '); 
            textContent = textContent.replace(/\s+/g, ' ').trim(); 

            const potentialChallengeLines = textContent.split(/[\n|]+/).map(line => line.trim()).filter(line => line.length > 15 && line.length < 150);
            
            potentialChallengeLines.forEach((line) => {
                const challengeKeywords = ['××ª×’×¨', '×‘×¢×™×”', '×§×•×©×™', '×—×¡×¨', '× ××•×š', '×’×‘×•×”', '×œ× ××¡×¤×™×§', '×¤×¢×¨', '×œ×§×•×™', '×“×•×¨×© ×©×™×¤×•×¨', '×˜×¢×•×Ÿ ×©×™×¤×•×¨', '×××ª×’×¨'];
                const hasKeywords = challengeKeywords.some(keyword => line.toLowerCase().includes(keyword));
                
                if (hasKeywords || /\d/.test(line)) { 
                    const schoolsCount = extractSchoolCount(line);
                    challenges.push(createChallengeObject(line, schoolsCount));
                }
            });
            
            const uniqueChallenges = challenges.filter((challenge, index, self) => 
                index === self.findIndex(c => c.category.substring(0, 40) === challenge.category.substring(0, 40)) 
            );
            return uniqueChallenges;
        }


        function extractFromJavaScriptFile(content) {
            const challenges = [];
            const challengePatterns = [
                /category:\s*['"`]([^'"`\n]{10,120})['"`]/g, 
                /title:\s*['"`](××ª×’×¨[^'"`\n]{5,100}|×§×•×©×™[^'"`\n]{5,100}|×‘×¢×™×”[^'"`\n]{5,100})['"`]/gi, 
                /text:\s*['"`]([^'"`\n]*?(?:××ª×’×¨|×‘×¢×™×”|×§×•×©×™)[^'"`\n]{5,100})['"`]/gi, 
            ];
            
            challengePatterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(content)) !== null) {
                    const challengeText = match[1] ? match[1].trim() : match[0].trim();
                    if (challengeText.length > 15 && challengeText.length < 120) {
                        const schoolsCount = extractSchoolCount(challengeText); 
                        challenges.push(createChallengeObject(challengeText, schoolsCount));
                    }
                }
            });

            if (challenges.length === 0) {
                const genericStrings = content.match(/['"`]([^'"`\n]{20,150})['"`]/g) || [];
                genericStrings.forEach(str => {
                    const cleanStr = str.slice(1, -1).trim();
                     const challengeKeywords = ['××ª×’×¨', '×‘×¢×™×”', '×§×•×©×™', '×—×¡×¨', '× ××•×š', '×’×‘×•×”', '×œ× ××¡×¤×™×§', '×¤×¢×¨'];
                    if (challengeKeywords.some(kw => cleanStr.toLowerCase().includes(kw)) && cleanStr.length > 15) {
                         challenges.push(createChallengeObject(cleanStr, Math.floor(Math.random() * 8) + 2));
                    }
                });
            }
            
            const uniqueChallenges = challenges.filter((challenge, index, self) => 
                index === self.findIndex(c => c.category.substring(0, 40) === challenge.category.substring(0, 40))
            );
            return uniqueChallenges;
        }


        function extractSchoolCount(text) {
            const schoolMatches = text.match(/(\d+)\s*(?:×‘×ª×™?\s*×¡×¤×¨|×‘×ª"×¡|×‘×ª\"×¡|×‘×™"×¡|×‘×™×¡)/i);
            if (schoolMatches) return parseInt(schoolMatches[1]);
            const numberMatches = text.match(/(\d+)(?:\s*%)?/); 
            if (numberMatches) {
                const num = parseInt(numberMatches[0]);
                if (text.includes('%') && num > 0 && num <=100) return Math.max(1, Math.round((num / 100) * 15));
                if (num > 0 && num < 50) return num; 
            }
            return Math.floor(Math.random() * 7) + 2; 
        }

        function createChallengeObject(text, schoolsCount) {
            let normalizedText = text.trim();
            const prefixesToRemove = ["××ª×’×¨×™ ", "××ª×’×¨ ", "×‘×¢×™×™×ª ", "×‘×¢×™×•×ª ", "×§×•×©×™ ×‘", "×§×©×™×™× ×‘", "×”×™×¢×“×¨ ", "×—×•×¡×¨ ×‘", "×¨××ª "];
            for (const prefix of prefixesToRemove) {
                if (normalizedText.toLowerCase().startsWith(prefix) && normalizedText.length > prefix.length + 10) {
                    normalizedText = normalizedText.substring(prefix.length);
                    break; 
                }
            }
            const categoryText = normalizedText.length > 70 ? normalizedText.substring(0, 70) + '...' : normalizedText;

            return {
                category: categoryText,
                affectedSchools: schoolsCount,
                details: [{ text: text, schools: schoolsCount }], 
                priority: schoolsCount 
            };
        }
        
        // --- START OF MODIFIED FUNCTION for Frequency (New Ranges) ---
        function getChallengeFrequency(challenge) {
            let percentage;
            const totalSchoolsInDistrict = (analysisData && analysisData.totalSchoolsForPercentageCalc > 0) ? analysisData.totalSchoolsForPercentageCalc : 20; 

            if (challenge.affectedSchools && challenge.affectedSchools > 0) {
                 percentage = Math.min(100, Math.round((challenge.affectedSchools / totalSchoolsInDistrict) * 100));
            } else {
                percentage = Math.floor(Math.random() * 20) + 5; 
            }
            challenge.percentage = percentage; 

            // ×©×›×™×—×•×ª ××¦×•××¦××ª - ×¢×“ 29% ××‘×ª×™ ×”×¡×¤×¨
            // ×©×›×™×—×•×ª ×¨×—×‘×” - 30-69% ××‘×ª×™ ×”×¡×¤×¨
            // ×©×›×™×—×•×ª ×¨×—×‘×” ×××•×“ - 70%+ ××‘×ª×™ ×”×¡×¤×¨
            if (percentage <= 29) return { label: '×©×›×™×—×•×ª ××¦×•××¦××ª', className: 'frequency-limited', percentage: percentage };
            if (percentage <= 69) return { label: '×©×›×™×—×•×ª ×¨×—×‘×”', className: 'frequency-wide', percentage: percentage };
            return { label: '×©×›×™×—×•×ª ×¨×—×‘×” ×××•×“', className: 'frequency-very-wide', percentage: percentage };
        }
        // --- END OF MODIFIED FUNCTION for Frequency (New Ranges) ---


        function loadDemoData() {
            showLoading(true);
            setTimeout(() => {
                analysisData = {
                    totalSchoolsForPercentageCalc: 20, 
                    challenges: [
                        { category: '×©×¤×” ×•×§×¨×™××”', affectedSchools: 5, details: [{ text: '×¨××ª ×”×‘× ×ª ×”× ×§×¨× ××™× ×” ××¡×¤×§×ª ×‘×›×™×ª×•×ª ×“-×•', schools: 5 }], priority: 5 }, // 25% -> ××¦×•××¦××ª
                        { category: '××ª××˜×™×§×” ×•××“×¢×™×', affectedSchools: 8, details: [{ text: '×©×œ×™×˜×” ×œ× ××¡×¤×§×ª ×‘××™×•×× ×•×™×•×ª ×™×¡×•×“ ×‘×—×©×‘×•×Ÿ', schools: 8 }], priority: 8 }, // 40% -> ×¨×—×‘×”
                        { category: '×× ×”×™×’×•×ª ×¤×“×’×•×’×™×ª', affectedSchools: 15, details: [{ text: '×× ×”×™×’×•×ª ×¤×“×’×•×’×™×ª ×”×“×•×¨×©×ª ×—×™×–×•×§', schools: 15 }], priority: 15 }, // 75% -> ×¨×—×‘×” ×××•×“
                        { category: '×©×™×ª×•×£ ×¤×¢×•×œ×” ×¦×•×•×ª×™', affectedSchools: 3, details: [{ text: '×”××•×¨×™× ××™× × ×¤×•×¢×œ×™× ×‘×©×™×ª×•×£ ×¤×¢×•×œ×” ××¡×¤×§', schools: 3 }], priority: 3 }, // 15% -> ××¦×•××¦××ª
                        { category: '××™×›×•×ª ×”×•×¨××” ×•×¤×™×ª×•×— ××§×¦×•×¢×™', affectedSchools: 12, details: [{ text: '×¤×¢×¨×™× ×‘×”×›×©×¨×” ×”××§×¦×•×¢×™×ª ×©×œ ×”×¦×•×•×ª', schools: 12 }], priority: 12 }, // 60% -> ×¨×—×‘×”
                        { category: '××¢×•×¨×‘×•×ª ×”×•×¨×™× ×•×§×”×™×œ×”', affectedSchools: 18, details: [{ text: '×”×©×ª×ª×¤×•×ª ××•×’×‘×œ×ª ×©×œ ×”×•×¨×™× ×‘×¤×¢×™×œ×•×™×•×ª ×‘×™×ª ×”×¡×¤×¨', schools: 18 }], priority: 18 } // 90% -> ×¨×—×‘×” ×××•×“
                    ]
                };
                showSuccess('× ×ª×•× ×™ ×”×“××• × ×˜×¢× ×• ×‘×”×¦×œ×—×”! 6 ××ª×’×¨×™× ×–××™× ×™× ×œ× ×™×ª×•×—.');
                showLoading(false);
                setTimeout(() => {
                    displayChallenges();
                    moveToStep(2);
                }, 1000);
            }, 1500);
        }
        
        function displayChallenges() {
            const container = document.getElementById('challengesGrid');
            container.innerHTML = '';
            if (!analysisData || !analysisData.challenges) {
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××ª×’×¨×™×. ×× × × ×¡×” ×©×•×‘.');
                return;
            }
            const sortedChallenges = [...analysisData.challenges].sort((a,b) => b.priority - a.priority);

            sortedChallenges.forEach((challenge) => {
                const card = document.createElement('div');
                card.className = 'challenge-card';
                const originalIndex = analysisData.challenges.findIndex(c => c.category === challenge.category && c.affectedSchools === challenge.affectedSchools);
                card.onclick = () => selectChallenge(originalIndex);
                
                const frequency = getChallengeFrequency(challenge); 
                const topDetail = challenge.details && challenge.details.length > 0 ? challenge.details.sort((a, b) => b.schools - a.schools)[0].text : challenge.category;

                card.innerHTML = `
                    <div class="challenge-badges">
                        <span class="frequency-badge ${frequency.className}">${frequency.label} (${frequency.percentage}%)</span>
                    </div>
                    <div class="challenge-title">${challenge.category}</div>
                    <div class="challenge-stats">
                        <span>ğŸ« ${challenge.affectedSchools} ×‘×ª×™ ×¡×¤×¨ ××•×©×¤×¢×™×</span>
                    </div>
                    <div class="challenge-description"><strong>×“×•×’××” ×œ×‘×™×˜×•×™ ×”××ª×’×¨:</strong><br>${topDetail.length > 100 ? topDetail.substring(0, 97) + '...' : topDetail}</div>`;
                container.appendChild(card);
            });
        }


        function selectChallenge(index) {
            if (index === -1 || !analysisData.challenges[index]) {
                console.error("Invalid index for selectChallenge:", index);
                showError("×©×’×™××” ×‘×‘×—×™×¨×ª ×”××ª×’×¨. × ×¡×” ×©×•×‘.");
                return;
            }
            document.querySelectorAll('.challenge-card').forEach(card => card.classList.remove('selected'));
            
            const challengeToSelect = analysisData.challenges[index];
            const allCards = document.querySelectorAll('.challenge-card');
            for (let card of allCards) {
                const titleEl = card.querySelector('.challenge-title');
                if (titleEl && titleEl.textContent === challengeToSelect.category) {
                    card.classList.add('selected');
                    break;
                }
            }
            
            selectedChallenge = challengeToSelect;
            document.getElementById('proceedBtn').disabled = false;
        }

        function proceedToAnalysis() {
            if (!selectedChallenge) return;
            if (typeof selectedChallenge.percentage === 'undefined') {
                getChallengeFrequency(selectedChallenge); 
            }

            document.getElementById('selectedChallengeTitle').textContent = `×”××ª×’×¨ ×”× ×‘×—×¨: ${selectedChallenge.category}`;
            const topChallengeDetail = selectedChallenge.details && selectedChallenge.details.length > 0 ?
                                   selectedChallenge.details.sort((a, b) => b.schools - a.schools)[0].text :
                                   selectedChallenge.category;
            document.getElementById('symptom').value = `×‘×©×˜×— ×× ×• ×¦×•×¤×™× ×‘: ${topChallengeDetail}. ×”×ª×•×¤×¢×” ××©×¤×™×¢×” ×¢×œ ×›-${selectedChallenge.percentage}% ××‘×ª×™ ×”×¡×¤×¨ ×‘××–×•×¨ ×”×¤×™×§×•×— (×›-${selectedChallenge.affectedSchools} ×‘×ª×™ ×¡×¤×¨).`;
            moveToStep(3);
        }

        function proceedToMapping() {
            whyAnalysis = {
                symptom: document.getElementById('symptom').value,
                why1: document.getElementById('why1').value,
                why2: document.getElementById('why2').value,
                why3: document.getElementById('why3').value,
                why4: document.getElementById('why4').value,
                why5: document.getElementById('why5').value
            };
            const emptyFields = Object.entries(whyAnalysis).filter(([key, value]) => !value.trim());
            if (emptyFields.length > 0) {
                showError('×× × ××œ× ××ª ×›×œ ×©×“×•×ª ×”× ×™×ª×•×— ×œ×¤× ×™ ×”××©×š');
                return;
            }
            generateFactorsFromAnalysis();
            displayFactorsMapping();
            moveToStep(4);
        }

        function generateFactorsFromAnalysis() {
            const allFactors = [];
            Object.keys(whyAnalysis).forEach(level => {
                if (whyAnalysis[level] && whyAnalysis[level].trim()) {
                    const factors = whyAnalysis[level].split(/[\nâ€¢;.]+/).map(f => f.trim()).filter(f => f.length > 5); 
                    factors.forEach(factor => {
                        allFactors.push({ text: factor, level: level, influence: determineInfluenceLevel(level) });
                    });
                }
            });
            factorsMapping = {
                high: allFactors.filter(f => f.influence === 'high'),
                medium: allFactors.filter(f => f.influence === 'medium'),
                low: allFactors.filter(f => f.influence === 'low')
            };
            generateBasicConnections();
        }

        function determineInfluenceLevel(level) {
            switch (level) {
                case 'why1': case 'why2': return 'high';
                case 'why3': case 'why4': return 'medium';
                case 'why5': case 'symptom': return 'low';
                default: return 'medium';
            }
        }

        function displayFactorsMapping() {
            displayFactorsInCategory('highInfluenceFactors', factorsMapping.high, 'high');
            displayFactorsInCategory('mediumInfluenceFactors', factorsMapping.medium, 'medium');
            displayFactorsInCategory('lowInfluenceFactors', factorsMapping.low, 'low');
            displayConnections();
        }

        function displayFactorsInCategory(containerId, factors, influenceLevel) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (factors.length === 0) {
                container.innerHTML = '<p style="color: #636e72; font-style: italic;">×œ× × ××¦××• ×’×•×¨××™× ×‘×§×˜×’×•×¨×™×” ×–×•</p>';
                return;
            }
            factors.forEach((factor) => {
                const factorElement = document.createElement('div');
                factorElement.className = 'factor-item';
                factorElement.innerHTML = `<span class="influence-level ${influenceLevel}-influence">${influenceLevel === 'high' ? '×’×‘×•×”×”' : influenceLevel === 'medium' ? '×‘×™× ×•× ×™×ª' : '× ××•×›×”'}</span>${factor.text}`;
                container.appendChild(factorElement);
            });
        }

        function generateBasicConnections() {
            connections = [];
            if (whyAnalysis.why5 && whyAnalysis.why4) connections.push({ from: '×’×•×¨××™ ×©×•×¨×© ×¢××•×§×™×', to: '×’×•×¨××™× ××‘× ×™×™×', description: '×”×’×•×¨××™× ×”×©×•×¨×©×™×™× ×™×•×¦×¨×™× ××ª ×”×‘×¢×™×•×ª ×”××‘× ×™×•×ª' });
            if (whyAnalysis.why4 && whyAnalysis.why3) connections.push({ from: '×’×•×¨××™× ××‘× ×™×™×', to: '×‘×¢×™×•×ª ××¢×¨×›×ª×™×•×ª', description: '×”×‘×¢×™×•×ª ×”××‘× ×™×•×ª ×’×•×¨××•×ª ×œ×§×©×™×™× ××¢×¨×›×ª×™×™×' });
            if (whyAnalysis.why3 && whyAnalysis.why2) connections.push({ from: '×‘×¢×™×•×ª ××¢×¨×›×ª×™×•×ª', to: '×’×•×¨××™× ××™×™×“×™×™×', description: '×”×§×©×™×™× ×”××¢×¨×›×ª×™×™× ××ª×‘×˜××™× ×‘×’×•×¨××™× ××™×™×“×™×™×' });
            if (whyAnalysis.why2 && whyAnalysis.why1) connections.push({ from: '×’×•×¨××™× ××™×™×“×™×™×', to: '×ª×¡××™× ×™× × ×¦×¤×™×', description: '×”×’×•×¨××™× ×”××™×™×“×™×™× ×™×•×¦×¨×™× ××ª ×”×ª×¡××™× ×™× ×©×× ×• ×¨×•××™×' });
        }

        function displayConnections() {
            const container = document.getElementById('connectionsContainer');
            container.innerHTML = '';
            if (connections.length === 0) {
                container.innerHTML = '<p style="color: #636e72; font-style: italic;">×œ× × ××¦××• ×§×©×¨×™× ×‘×™×Ÿ ×’×•×¨××™×</p>';
                return;
            }
            connections.forEach(connection => {
                const connectionElement = document.createElement('div');
                connectionElement.className = 'connection-item';
                connectionElement.innerHTML = `<span>${connection.from}</span><span class="connection-arrow">â†’</span><span>${connection.to}</span><div style="font-size: 0.9em; color: #636e72; margin-top: 5px;">${connection.description}</div>`;
                container.appendChild(connectionElement);
            });
        }

        function generateSummary() {
            const summary = {
                challenge: selectedChallenge.category,
                rootCauses: whyAnalysis.why5 ? whyAnalysis.why5.split(/[\nâ€¢;.]+/).filter(c => c.trim().length > 5) : [],
                highPriorityFactors: factorsMapping.high.map(f => f.text),
                keyConnections: connections.map(c => `${c.from} â†’ ${c.to}`),
                recommendations: generateRecommendations()
            };
            displaySummary(summary);
            moveToStep(5);
        }

        function generateRecommendations() {
            const recommendations = [];
            if (factorsMapping.high.length > 0) {
                recommendations.push('×”×ª××§×“ ×‘×’×•×¨××™× ×‘×¢×œ×™ ×”×©×¤×¢×” ×’×‘×•×”×” ×›×¢×“×™×¤×•×ª ×¨××©×•× ×”');
                recommendations.push('×¤×ª×— ×ª×•×›× ×™×ª ×¤×¢×•×œ×” ×¡×¤×¦×™×¤×™×ª ×œ×›×œ ×’×•×¨× ×‘×¢×“×™×¤×•×ª ×’×‘×•×”×”');
            }
            if (factorsMapping.medium.length > 0) recommendations.push('×¦×•×¨ ×ª×•×›× ×™×ª ×‘×™× ×™×™× ×œ×˜×™×¤×•×œ ×‘×’×•×¨××™× ×‘×¢×œ×™ ×”×©×¤×¢×” ×‘×™× ×•× ×™×ª');
            if (connections.length > 2) recommendations.push('×”×ª×™×™×—×¡ ×œ×§×©×¨×™× ×‘×™×Ÿ ×”×’×•×¨××™× ×‘×ª×›× ×•×Ÿ ×”×”×ª×¢×¨×‘×•×ª');
            
            const categoryLower = selectedChallenge.category.toLowerCase();
            if (categoryLower.includes('×©×¤×”') || categoryLower.includes('×§×¨×™××”')) {
                recommendations.push('×©×§×•×œ ×”×§××ª ××¨×›×– ×›×ª×™×‘×” ×•×§×¨×™××” ×‘×™×ª ×¡×¤×¨×™');
                recommendations.push('×¤×ª×— ×ª×•×›× ×™×ª ×§×¨×™××” ××•×ª×××ª ××™×©×™×ª ×œ×ª×œ××™×“×™×');
            } else if (categoryLower.includes('××ª××˜×™×§×”') || categoryLower.includes('××“×¢')) {
                recommendations.push('×”×˜××¢ ×©×™×˜×•×ª ×”×•×¨××” ×—×–×•×ª×™×•×ª ×•×× ×™×¤×•×œ×˜×™×‘×™×•×ª');
                recommendations.push('×¤×ª×— ×ª×•×›× ×™×ª ×œ×”×¤×—×ª×ª ×—×¨×“×ª ××ª××˜×™×§×”');
            } else if (categoryLower.includes('×× ×”×™×’×•×ª')) {
                recommendations.push('×§×™×™× ×ª×•×›× ×™×ª ×¤×™×ª×•×— ×× ×”×™×’×•×ª ×œ×¦×•×•×ª ×”×”× ×”×œ×”');
                recommendations.push('×”×˜××¢ ××¢×¨×›×ª ×§×‘×œ×ª ×”×—×œ×˜×•×ª ××‘×•×¡×¡×ª × ×ª×•× ×™×');
            } else {
                recommendations.push('×¤×ª×— ×ª×•×›× ×™×ª ×”×ª×¢×¨×‘×•×ª ××•×ª×××ª ×œ××ª×’×¨ ×”×¡×¤×¦×™×¤×™');
            }
            recommendations.push('×§×‘×¢ ××“×“×™ ×”×¦×œ×—×” ×‘×¨×•×¨×™× ×•××“×™×“×™×');
            recommendations.push('×‘×¦×¢ ×”×¢×¨×›×” ×ª×§×•×¤×ª×™×ª ×©×œ ×™×¢×™×œ×•×ª ×”×”×ª×¢×¨×‘×•×ª');
            return recommendations;
        }

        function displaySummary(summary) {
            document.getElementById('challengeSummary').innerHTML = `<h4 style="color: #667eea;">${summary.challenge}</h4><p>×”××ª×’×¨ ×©× ×•×ª×— ×‘×¢×•××§ ×‘×××¦×¢×•×ª ×©×™×˜×ª 5 Why's</p>`;
            document.getElementById('rootCausesSummary').innerHTML = summary.rootCauses.length > 0 ? summary.rootCauses.map(cause => `â€¢ ${cause.trim()}`).join('<br>') : '<p style="color: #636e72; font-style: italic;">×œ× ×–×•×”×• ×’×•×¨××™ ×©×•×¨×© ×¡×¤×¦×™×¤×™×™×</p>';
            document.getElementById('highPriorityFactors').innerHTML = summary.highPriorityFactors.length > 0 ? summary.highPriorityFactors.map(factor => `â€¢ ${factor}`).join('<br>') : '<p style="color: #636e72; font-style: italic;">×œ× × ××¦××• ×’×•×¨××™× ×‘×¢×“×™×¤×•×ª ×’×‘×•×”×”</p>';
            document.getElementById('keyConnections').innerHTML = summary.keyConnections.length > 0 ? summary.keyConnections.map(connection => `â€¢ ${connection}`).join('<br>') : '<p style="color: #636e72; font-style: italic;">×œ× ×–×•×”×• ×§×©×¨×™× ××¨×›×–×™×™×</p>';
            document.getElementById('actionRecommendations').innerHTML = summary.recommendations.map(rec => `â€¢ ${rec}`).join('<br>');
        }

        function downloadAnalysis() {
            const analysisReport = generateAnalysisReport();
            const fileName = `× ×™×ª×•×—_×¡×™×‘×•×ª_×©×•×¨×©_${selectedChallenge.category.replace(/[^\w\u0590-\u05FF\s]/g, '').replace(/\s+/g, '_')}_${new Date().toLocaleDateString('he-IL').replace(/\./g, '_')}.html`;
            downloadFile(analysisReport, fileName, 'text/html');
        }

        function generateAnalysisReport() {
            const currentDate = new Date().toLocaleDateString('he-IL');
            const currentTime = new Date().toLocaleTimeString('he-IL');
            const whyText = (field) => (whyAnalysis[field] || '×œ× ×¦×•×™×Ÿ').replace(/\n/g, '<br>');

            return `<!DOCTYPE html><html dir="rtl" lang="he"><head><meta charset="UTF-8"><title>×“×•×— × ×™×ª×•×— ×¡×™×‘×•×ª ×©×•×¨×© - ${selectedChallenge.category}</title><style>body{font-family:'Segoe UI',Arial,sans-serif;direction:rtl;margin:20px;background:#f8f9fa;line-height:1.6;}.header{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:30px;border-radius:10px;text-align:center;margin-bottom:30px;}.section{background:white;padding:25px;margin-bottom:25px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}.why-level{margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;border-right:4px solid #667eea;}h1,h2,h3{color:#2d3436;}</style></head><body><div class="header"><h1>ğŸ” ×“×•×— × ×™×ª×•×— ×¡×™×‘×•×ª ×©×•×¨×©</h1><h2>${selectedChallenge.category}</h2></div><div class="section"><h2>ğŸ¯ ×”××ª×’×¨ ×©× ×•×ª×—</h2><p><strong>×§×˜×’×•×¨×™×”:</strong> ${selectedChallenge.category}</p><p><strong>×©×›×™×—×•×ª:</strong> ×›-${selectedChallenge.percentage}% ××‘×ª×™ ×”×¡×¤×¨ (×›-${selectedChallenge.affectedSchools} ×‘×ª×™ ×¡×¤×¨)</p></div><div class="section"><h2>ğŸ¤” × ×™×ª×•×— 5 Why's</h2><div class="why-level"><h3>ğŸ¯ ×”×ª×¡××™×Ÿ</h3><p>${whyText('symptom')}</p></div><div class="why-level"><h3>â“ ×œ××” 1</h3><p>${whyText('why1')}</p></div><div class="why-level"><h3>â“ ×œ××” 2</h3><p>${whyText('why2')}</p></div><div class="why-level"><h3>â“ ×œ××” 3</h3><p>${whyText('why3')}</p></div><div class="why-level"><h3>â“ ×œ××” 4</h3><p>${whyText('why4')}</p></div><div class="why-level"><h3>ğŸ¯ ×œ××” 5 (×©×•×¨×©)</h3><p>${whyText('why5')}</p></div></div><div class="section"><h2>ğŸ—ºï¸ ××™×¤×•×™ ×’×•×¨××™×</h2><h3>ğŸ”´ ×”×©×¤×¢×” ×’×‘×•×”×”</h3>${factorsMapping.high.map(f => `<p>â€¢ ${f.text}</p>`).join('') || '<p><em>×œ× ×–×•×”×•</em></p>'}<h3>ğŸŸ¡ ×”×©×¤×¢×” ×‘×™× ×•× ×™×ª</h3>${factorsMapping.medium.map(f => `<p>â€¢ ${f.text}</p>`).join('') || '<p><em>×œ× ×–×•×”×•</em></p>'}<h3>ğŸ”µ ×”×©×¤×¢×” × ××•×›×”</h3>${factorsMapping.low.map(f => `<p>â€¢ ${f.text}</p>`).join('') || '<p><em>×œ× ×–×•×”×•</em></p>'}</div><div class="section"><h2>ğŸ’¡ ×”××œ×¦×•×ª</h2>${generateRecommendations().map(rec => `<p>â€¢ ${rec}</p>`).join('')}</div><footer style="text-align:center;color:#666;"><p>×”×•×¤×§: ${currentDate} ${currentTime}</p></footer></body></html>`;
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType + ';charset=utf-8' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showSuccess('×”×“×•×— ×”×•×¨×“ ×‘×”×¦×œ×—×”!');
        }
        
        function goBack() { 
            if (currentStep > 1) {
                moveToStep(currentStep - 1);
            }
        }

        function startNewAnalysis() {
            selectedChallenge = null;
            whyAnalysis = {};
            factorsMapping = { high: [], medium: [], low: [] };
            connections = [];
            analysisData = null;
            document.querySelectorAll('.challenge-card').forEach(card => card.classList.remove('selected'));
            document.getElementById('proceedBtn').disabled = true;
            // ××™×Ÿ ×¦×•×¨×š ×œ××¤×¡ ××ª fileInput ×›××Ÿ ×›×™ ×”×•× × ×•×¦×¨ ×“×™× ××™×ª
            document.getElementById('fileInfo').style.display = 'none';
            ['symptom', 'why1', 'why2', 'why3', 'why4', 'why5'].forEach(id => { document.getElementById(id).value = ''; });
            moveToStep(1);
            showSuccess('×”× ×™×ª×•×— ××•×¤×¡. × ×™×ª×Ÿ ×œ×”×ª×—×™×œ ××—×“×©.');
        }

        function moveToStep(step) {
            document.querySelectorAll('.step-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            updateProgressIndicator(step);
            currentStep = step;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateProgressIndicator(step) {
            for (let i = 1; i <= 5; i++) {
                const stepElement = document.getElementById(`step${i}Progress`);
                stepElement.classList.remove('active', 'completed');
                if (i < step) {
                    stepElement.classList.add('completed');
                } else if (i === step) {
                    stepElement.classList.add('active');
                }
            }
        }
        
        function populateSuggestionDropdowns() {
            Object.keys(whySuggestions).forEach(whyKey => {
                const selectElement = document.getElementById(`${whyKey}-select`);
                if (selectElement) {
                    selectElement.innerHTML = '<option value="">×‘×—×¨ ×”×¦×¢×” ×œ×”×•×¡×¤×”...</option>'; 
                    const suggestions = whySuggestions[whyKey];
                    suggestions.forEach(suggestion => {
                        const option = document.createElement('option');
                        option.value = suggestion;
                        option.textContent = suggestion;
                        selectElement.appendChild(option);
                    });
                }
            });
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            updateProgressIndicator(1);
            populateSuggestionDropdowns();
            console.log('××¤×œ×™×§×¦×™×™×ª × ×™×ª×•×— ×¡×™×‘×•×ª ×©×•×¨×© ×˜×•×¢× ×ª...');

            const fileUploadArea = document.getElementById('fileUploadArea');
            if (fileUploadArea) {
                fileUploadArea.addEventListener('click', triggerFileUpload);
            }
        });

        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('why-input')) {
                const fieldId = e.target.id;
                if (whyAnalysis) {
                    whyAnalysis[fieldId] = e.target.value;
                }
            }
        });
        
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('suggestion-select')) {
                const selectElement = e.target;
                const selectedValue = selectElement.value;
                
                if (!selectedValue) return;

                const textareaId = selectElement.id.replace('-select', '');
                const textarea = document.getElementById(textareaId);

                if (textarea.value.trim() === '') {
                    textarea.value = `â€¢ ${selectedValue}`;
                } else {
                    textarea.value += `\n\nâ€¢ ${selectedValue}`;
                }

                if (whyAnalysis) {
                    whyAnalysis[textareaId] = textarea.value;
                }
                
                selectElement.selectedIndex = 0;
                textarea.dispatchEvent(new Event('input', { bubbles: true }));
            }
        });
    </script>
</body>
</html>
